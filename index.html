<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‰ãƒªã‚¸ã‚§ãƒ</title>
<style>
:root{
  --p:#C368F9;--i:#876AFF;--e:#60E2B7;--ed:#38b896;
  --pl:#f8eeff;--pm:#e8c0fd;--il:#f0edff;--el:#e0fdf4;
  --tx:#2d2040;--gr:#8878a0;--bd:#e4d8f8;--r:16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Hiragino Maru Gothic Pro','Yu Gothic',sans-serif;background:linear-gradient(160deg,#fdf6ff,#f0edff);color:var(--tx);min-height:100dvh;}

/* ===== GLOBAL NAV ===== */
.gnav{display:flex;background:white;border-bottom:2px solid var(--pm);position:sticky;top:56px;z-index:90;}
.gnav button{flex:1;padding:10px 4px;border:none;background:none;font-family:inherit;font-size:12px;cursor:pointer;color:var(--gr);border-bottom:3px solid transparent;transition:all .2s;}
.gnav button.act{font-weight:900;color:var(--p);border-bottom-color:var(--p);}

header{background:linear-gradient(135deg,var(--p),var(--i));color:white;text-align:center;padding:14px 16px 12px;position:sticky;top:0;z-index:100;box-shadow:0 4px 16px rgba(135,106,255,.3);}
header h1{font-size:20px;font-weight:900;}
header p{font-size:11px;opacity:.9;margin-top:2px;}

main{max-width:520px;margin:0 auto;padding:16px 16px 80px;}

/* ===== DRILL UI ===== */
.progress-wrap{margin-bottom:20px;}
.progress-bar{display:flex;gap:6px;justify-content:center;margin-bottom:6px;}
.prog-dot{width:10px;height:10px;border-radius:50%;background:#ddd;transition:all .3s;}
.prog-dot.done{background:var(--i);}
.prog-dot.active{background:var(--p);box-shadow:0 0 0 3px rgba(195,104,249,.25);transform:scale(1.3);}
.prog-label{text-align:center;font-size:11px;color:var(--gr);}

.step{display:none;animation:fadeIn .3s ease;}
.step.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.step-badge{display:inline-flex;align-items:center;background:linear-gradient(135deg,var(--p),var(--i));color:white;font-size:11px;font-weight:bold;padding:3px 12px;border-radius:20px;margin-bottom:10px;}
.step-title{font-size:20px;font-weight:900;margin-bottom:4px;line-height:1.3;}
.step-sub{font-size:13px;color:var(--gr);margin-bottom:16px;line-height:1.5;}

.card-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.card-grid.three{grid-template-columns:1fr 1fr 1fr;}
.choice-card{border:2.5px solid var(--bd);border-radius:var(--r);padding:14px 10px;text-align:center;cursor:pointer;background:white;transition:all .15s;user-select:none;position:relative;min-height:86px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(135,106,255,.06);}
.choice-card:active{transform:scale(.97);}
.choice-card.selected{border-color:var(--p);background:var(--pl);box-shadow:0 4px 14px rgba(195,104,249,.22);}
.choice-card .icon{font-size:26px;margin-bottom:5px;}
.choice-card .label{font-size:12px;font-weight:bold;line-height:1.3;}
.choice-card .desc{font-size:10px;color:var(--gr);margin-top:2px;line-height:1.3;}
.checkmark{position:absolute;top:7px;right:7px;width:19px;height:19px;border-radius:50%;background:white;border:2px solid var(--bd);transition:all .15s;}
.choice-card.selected .checkmark{background:var(--p);border-color:var(--p);}
.choice-card.selected .checkmark::after{content:'âœ“';color:white;font-size:10px;display:flex;align-items:center;justify-content:center;line-height:19px;}
.section-label{grid-column:1/-1;font-size:12px;color:var(--i);font-weight:bold;padding:7px 4px 3px;border-bottom:1px solid var(--il);margin-top:4px;}

.btn-row{display:flex;gap:10px;margin-top:18px;}
.btn{flex:1;padding:13px 16px;border-radius:30px;border:none;font-size:14px;font-weight:bold;cursor:pointer;transition:all .2s;font-family:inherit;min-height:48px;}
.btn-back{background:#f0ecff;color:var(--i);flex:0 0 auto;padding:13px 18px;}
.btn-next{background:linear-gradient(135deg,var(--p),var(--i));color:white;box-shadow:0 4px 12px rgba(195,104,249,.35);}
.btn-next:disabled{background:#ddd;color:#aaa;box-shadow:none;}
.btn-print{background:linear-gradient(135deg,var(--ed),var(--e));color:white;font-size:15px;box-shadow:0 4px 14px rgba(96,226,183,.3);}
.btn-reset{background:none;border:1.5px solid var(--bd);color:var(--gr);font-size:12px;padding:9px 16px;border-radius:30px;cursor:pointer;font-family:inherit;margin:8px auto 0;display:block;min-height:42px;}

.summary-box{background:white;border-radius:var(--r);border:2px solid var(--pm);padding:15px;margin-top:18px;box-shadow:0 4px 12px rgba(195,104,249,.1);}
.summary-box h3{font-size:12px;color:var(--gr);margin-bottom:10px;}
.summary-row{display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid #f5f0ff;font-size:13px;}
.summary-row:last-child{border-bottom:none;}
.summary-label{color:var(--gr);font-size:11px;min-width:70px;padding-top:1px;}
.summary-val{font-weight:bold;flex:1;line-height:1.4;}
.print-notice{background:#fffbe8;border:1.5px solid #f5c800;border-radius:12px;padding:11px 13px;margin-top:14px;font-size:11px;color:#665500;line-height:1.6;}

/* ===== ã‹ã‚“ã‚Šã‚‡ã†ã‚«ãƒ¼ãƒ‰ ===== */
.kanryo-card{background:white;border-radius:20px;border:2.5px solid var(--pm);padding:20px 16px;margin-top:16px;text-align:center;box-shadow:0 8px 24px rgba(195,104,249,.15);}
.kanryo-card h3{font-size:16px;font-weight:900;color:var(--p);margin-bottom:6px;}
.kanryo-card p{font-size:12px;color:var(--gr);margin-bottom:14px;line-height:1.5;}
.btn-kanryo{width:100%;padding:14px;border-radius:30px;border:none;background:linear-gradient(135deg,var(--p),var(--i));color:white;font-size:15px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 6px 20px rgba(195,104,249,.4);transition:transform .1s;}
.btn-kanryo:active{transform:scale(.97);}

/* ===== IKUSEI UI ===== */
.creature-card{background:white;border-radius:24px;padding:18px 14px;box-shadow:0 8px 32px rgba(195,104,249,.15);border:2px solid var(--pm);position:relative;overflow:hidden;margin-bottom:14px;}
.xp-bar-wrap{margin-bottom:8px;}
.xp-bar-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--gr);margin-bottom:3px;}
.xp-bar-bg{background:#e8e0ff;border-radius:99px;height:12px;overflow:hidden;}
.xp-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--p),var(--i));transition:width .8s cubic-bezier(.4,2,.6,1);box-shadow:0 0 8px rgba(195,104,249,.5);}
.stat-grid{display:flex;gap:8px;margin-top:12px;}
.stat-item{flex:1;background:var(--pl);border-radius:12px;padding:8px 4px;text-align:center;}
.stat-icon{font-size:17px;}
.stat-label{font-size:9px;color:var(--gr);margin-top:1px;}
.stat-val{font-size:12px;font-weight:700;color:var(--i);}
.drill-type-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;}
.dtype-btn{padding:5px 9px;border-radius:99px;border:1.5px solid;font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s;}

.tab-content{animation:fadeIn .2s ease;}

/* ãƒãƒƒã‚¸ã‚°ãƒªãƒƒãƒ‰ */
.badge-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.badge-item{background:white;border-radius:14px;padding:14px 10px;text-align:center;border:2px solid;}
.badge-item.earned{border-color:var(--pm);box-shadow:0 4px 12px rgba(195,104,249,.12);}
.badge-item.locked{border-color:#e0e0e0;opacity:.5;background:#f5f5f5;}

/* ãƒ­ã‚° */
.log-item{background:white;border-radius:14px;padding:11px 13px;margin-bottom:7px;border:1.5px solid var(--bd);display:flex;align-items:center;gap:11px;}
.log-icon{width:38px;height:38px;border-radius:11px;background:linear-gradient(135deg,#C368F922,#876AFF22);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:white;border:3px solid #f5c800;border-radius:20px;padding:11px 22px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:500;white-space:nowrap;animation:slideUp .4s cubic-bezier(.4,2,.6,1);}
.levelup-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border:3px solid var(--p);border-radius:16px;padding:12px 20px;text-align:center;box-shadow:0 8px 24px rgba(195,104,249,.4);z-index:10;animation:popIn .4s cubic-bezier(.4,2,.6,1);}

@keyframes popIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
@keyframes slideUp{0%{opacity:0;transform:translateX(-50%) translateY(20px)}100%{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes particleFly{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-44px) scale(1.6)}}
@keyframes creatureBounce{0%,100%{transform:translateY(0) scale(1,1)}40%{transform:translateY(-18px) scale(.95,1.08)}60%{transform:translateY(-14px) scale(.97,1.05)}}
@keyframes floatAnim{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes eyeBlink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}
@keyframes tentacle1{0%,100%{transform:rotate(0deg)}50%{transform:rotate(12deg)}}
@keyframes tentacle2{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-12deg)}}
@keyframes sparkleAnim{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}

/* ===== PRINT ===== */
@media print{
  @page{size:A4 landscape;margin:0;}
  body>*{display:none!important;}
  #print-target{display:block!important;}
}
#print-target{display:none;}
.drill-page{width:297mm;height:210mm;background:white;padding:5mm 7mm;display:flex;flex-direction:column;position:relative;overflow:hidden;page-break-after:always;}
.drill-two-col{display:flex;gap:5mm;flex:1;min-height:0;}
.drill-col{flex:1;display:flex;flex-direction:column;min-width:0;}
.drill-divider{width:1px;background:#e8e0f8;flex-shrink:0;}
.drill-pid{position:absolute;top:3mm;right:7mm;font-size:8pt;color:#ccc;}
.d-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5mm;}
.d-title{font-size:11.5pt;font-weight:bold;color:#2d2040;}
.d-brand{font-size:8pt;font-weight:bold;background:linear-gradient(135deg,#C368F9,#876AFF);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.d-meta{display:flex;align-items:center;gap:4px;margin-bottom:1.5mm;font-size:8pt;color:#888;}
.d-circle{width:20px;height:20px;border:1.5px solid #ccc;border-radius:50%;display:inline-block;flex-shrink:0;}
.d-name{border:1.5px solid #ccc;border-radius:3px;flex:1;height:19px;}
.d-instr{font-size:9.5pt;font-weight:bold;color:#2d2040;margin-bottom:1.5mm;display:flex;align-items:center;gap:4px;}
.d-zz-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;flex-direction:column;gap:2mm;min-height:0;}
.d-zz-row{display:flex;align-items:center;justify-content:space-between;border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;}
.d-zz-guide{position:absolute;left:58px;right:58px;top:50%;border-top:2.5px dashed #e0a8fc;transform:translateY(-50%);}
.d-vert-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;gap:2mm;}
.d-vert-col{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:space-between;border-radius:3px;background:white;padding:5px 3px;position:relative;}
.d-vert-guide{position:absolute;top:48px;bottom:48px;left:50%;border-left:2.5px dashed #e0a8fc;transform:translateX(-50%);}
.d-wave-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-wave-row{border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;display:flex;align-items:center;justify-content:space-between;overflow:hidden;}
.d-wave-svg{position:absolute;left:58px;right:58px;top:0;bottom:0;width:calc(100% - 116px);height:100%;}
.d-zg-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-zg-row{border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;display:flex;align-items:center;justify-content:space-between;overflow:hidden;}
.om{width:54px;height:54px;object-fit:contain;flex-shrink:0;}
.om-sm{width:40px;height:40px;object-fit:contain;flex-shrink:0;}
.d-cards-col{display:flex;flex-direction:column;gap:2.5mm;flex:1;min-height:0;}
.d-card-pair{display:flex;gap:2.5mm;flex:1;}
.d-kana-card{border-radius:9px;padding:3px 5px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.d-bubble{background:white;border-radius:12px;padding:2px 8px;font-size:14pt;font-weight:bold;color:#2d2040;margin-bottom:2px;display:inline-block;}
.d-card-om{width:60px;height:60px;object-fit:contain;}
.d-grids{display:flex;gap:4mm;justify-content:center;margin-top:2mm;flex-shrink:0;}
.d-grid-block{display:flex;flex-direction:column;gap:1mm;}
.d-gnum{font-size:7.5pt;color:#aaa;}
.d-gcells{display:flex;}
.d-cell{width:10mm;height:10mm;border:1.5px solid #ccc;position:relative;}
.d-cell::after{content:'';position:absolute;left:50%;top:0;bottom:0;border-left:1px dashed #eee;}
.d-cell::before{content:'';position:absolute;top:50%;left:0;right:0;border-top:1px dashed #eee;}
.d-slash{background:linear-gradient(to bottom right,transparent calc(50% - 1px),#ccc 50%,transparent calc(50% + 1px));}
.d-keisan-frame{border:3.5px solid #60E2B7;border-radius:5px;padding:2.5mm;background:#b0f4e0;flex:1;display:flex;flex-direction:column;}
.d-keisan-grid{display:grid;gap:1.5mm;flex:1;}
.d-keisan-item{background:white;border-radius:3px;display:flex;align-items:center;justify-content:center;gap:3px;font-weight:900;color:#2d2040;padding:2px 4px;}
.d-ans-box{border-bottom:2px solid #876AFF;min-width:22px;height:18px;display:inline-block;margin-left:2px;}
.d-qnum{font-size:7pt;color:#aaa;margin-right:1px;}
.d-kanji-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;flex-direction:column;gap:1.5mm;}
.d-kanji-row{border-radius:3px;background:white;flex:1;padding:3px 6px;display:flex;align-items:center;gap:6px;}
.d-kanji-char{font-size:20pt;font-weight:900;color:#2d2040;min-width:34px;text-align:center;border-right:2px solid #f0e8ff;padding-right:6px;}
.d-kanji-info{flex:1;font-size:8pt;color:#555;line-height:1.5;}
.d-kanji-write{display:flex;}
.d-tokei-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:row;flex-wrap:wrap;gap:2mm;align-content:flex-start;}
.d-clock-cell{background:white;border-radius:5px;padding:3px;flex:0 0 calc(33.3% - 1.5mm);display:flex;flex-direction:column;align-items:center;}
.d-clock-svg{width:46px;height:46px;}
.d-clock-write{display:flex;margin-top:2px;}
.d-kazu-frame{border:3.5px solid #60E2B7;border-radius:5px;padding:2.5mm;background:#b0f4e0;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-kazu-row{border-radius:3px;background:white;flex:1;padding:4px 10px;display:flex;align-items:center;gap:8px;}
.d-kazu-num{font-size:22pt;font-weight:900;color:#2d2040;min-width:32px;text-align:center;}
.d-kazu-dots{display:flex;flex-wrap:wrap;gap:3px;align-items:center;max-width:120px;}
.d-dot{width:14px;height:14px;border-radius:50%;background:#C368F9;display:inline-block;}
.d-kazu-write{display:flex;margin-left:auto;}
</style>
</head>
<body>
<header>
  <h1>âœï¸ ãƒ‰ãƒªã‚¸ã‚§ãƒ</h1>
  <p>ãƒ‰ãƒªãƒ«ã‚’ä½œã£ã¦ãƒ ãƒ‹ã¡ã‚ƒã‚“ã‚’è‚²ã¦ã‚ˆã†ï¼</p>
</header>

<!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ -->
<div class="gnav">
  <button id="nav-drill" class="act" onclick="switchTab('drill')">ğŸ“„ ãƒ‰ãƒªãƒ«</button>
  <button id="nav-ikusei" onclick="switchTab('ikusei')">ğŸ¥š ãã ã¦ã‚‹</button>
  <button id="nav-log" onclick="switchTab('log')">ğŸ“‹ ãã‚ã</button>
  <button id="nav-badges" onclick="switchTab('badges')">ğŸ… ãƒãƒƒã‚¸</button>
</div>

<main>
  <!-- ===== DRILL TAB ===== -->
  <div id="tab-drill" class="tab-content">
    <div style="height:12px"></div>
    <div class="progress-wrap">
      <div class="progress-bar">
        <div class="prog-dot active" id="p0"></div>
        <div class="prog-dot" id="p1"></div>
        <div class="prog-dot" id="p2"></div>
        <div class="prog-dot" id="p3"></div>
      </div>
      <div class="prog-label" id="prog-label">STEP 1 / 4 â€” ã ã‚Œã®ãƒ‰ãƒªãƒ«ï¼Ÿ</div>
    </div>

    <div class="step active" id="step0">
      <div class="step-badge">STEP 1 / 4</div>
      <div class="step-title">ã ã‚Œã®ãƒ‰ãƒªãƒ«ã‚’ä½œã‚‹ï¼Ÿ</div>
      <div class="step-sub">å¹´é½¢ã¾ãŸã¯å­¦å¹´ã‚’é¸ã‚“ã§ã­</div>
      <div class="card-grid">
        <div class="choice-card" data-val="yoji2" onclick="selectOne(this,'age')"><div class="icon">ğŸ£</div><div class="label">2ã€œ3æ­³</div><div class="desc">é‹ç­†ãƒ»è‰²ãƒ»å½¢</div></div>
        <div class="choice-card" data-val="yoji4" onclick="selectOne(this,'age')"><div class="icon">ğŸ¥</div><div class="label">4ã€œ5æ­³</div><div class="desc">ã²ã‚‰ãŒãªãƒ»ã‹ãš</div></div>
        <div class="choice-card" data-val="yoji6" onclick="selectOne(this,'age')"><div class="icon">ğŸŒŸ</div><div class="label">å¹´é•·ï¼ˆ5ã€œ6æ­³ï¼‰</div><div class="desc">å…¥å­¦æº–å‚™ãƒ»è¨€è‘‰</div></div>
        <div class="choice-card" data-val="sho1" onclick="selectOne(this,'age')"><div class="icon">ğŸ’</div><div class="label">å°å­¦1å¹´ç”Ÿ</div><div class="desc">å›½èªãƒ»ç®—æ•°</div></div>
        <div class="choice-card" data-val="sho2" onclick="selectOne(this,'age')"><div class="icon">ğŸ“š</div><div class="label">å°å­¦2å¹´ç”Ÿ</div><div class="desc">æ¼¢å­—ãƒ»ãŸã—ç®—</div></div>
        <div class="choice-card" data-val="sho3" onclick="selectOne(this,'age')"><div class="icon">ğŸ“</div><div class="label">å°å­¦3å¹´ç”Ÿ</div><div class="desc">æ¼¢å­—ãƒ»ã‹ã‘ç®—</div></div>
      </div>
      <div class="btn-row"><button class="btn btn-next" id="next0" onclick="goStep(1)" disabled>ã¤ãã¸ â†’</button></div>
    </div>

    <div class="step" id="step1">
      <div class="step-badge">STEP 2 / 4</div>
      <div class="step-title">ã©ã‚“ãªç·´ç¿’ã‚’ã™ã‚‹ï¼Ÿ</div>
      <div class="step-sub">è¤‡æ•°é¸ã¹ã‚‹ã‚ˆï¼ˆ1ã¤ä»¥ä¸Šãˆã‚‰ã‚“ã§ã­ï¼‰</div>
      <div class="card-grid" id="subject-grid"></div>
      <div class="btn-row">
        <button class="btn btn-back" onclick="goStep(0)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next" id="next1" onclick="goStep(2)" disabled>ã¤ãã¸ â†’</button>
      </div>
    </div>

    <div class="step" id="step2">
      <div class="step-badge">STEP 3 / 4</div>
      <div class="step-title">ç·´ç¿’ã®ç¨®é¡ã‚’é¸ã¼ã†ï¼</div>
      <div class="step-sub">è¤‡æ•°é¸ã¹ã‚‹ã‚ˆ</div>
      <div id="detail-grid" class="card-grid"></div>
      <div class="btn-row">
        <button class="btn btn-back" onclick="goStep(1)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next" id="next2" onclick="goStep(3)" disabled>ã¤ãã¸ â†’</button>
      </div>
    </div>

    <div class="step" id="step3">
      <div class="step-badge">STEP 4 / 4</div>
      <div class="step-title">ãƒšãƒ¼ã‚¸æ•°ã‚’é¸ã¼ã†ï¼</div>
      <div class="step-sub">A4æ¨ªãƒ»1æšã«2ç¨®é¡å…¥ã‚‹ã‚ˆ</div>
      <div class="card-grid three">
        <div class="choice-card" data-val="1" onclick="selectOne(this,'pages')"><div class="icon">ğŸ“„</div><div class="label">1æš</div></div>
        <div class="choice-card" data-val="2" onclick="selectOne(this,'pages')"><div class="icon">ğŸ“„</div><div class="label">2æš</div></div>
        <div class="choice-card" data-val="3" onclick="selectOne(this,'pages')"><div class="icon">ğŸ“š</div><div class="label">3æš</div></div>
        <div class="choice-card" data-val="4" onclick="selectOne(this,'pages')"><div class="icon">ğŸ“š</div><div class="label">4æš</div></div>
        <div class="choice-card" data-val="5" onclick="selectOne(this,'pages')"><div class="icon">ğŸ—‚ï¸</div><div class="label">5æš</div></div>
      </div>
      <div class="summary-box">
        <h3>ğŸ“‹ ãˆã‚‰ã‚“ã å†…å®¹</h3>
        <div class="summary-row"><span class="summary-label">å¹´é½¢ãƒ»å­¦å¹´</span><span class="summary-val" id="sum-age">â€”</span></div>
        <div class="summary-row"><span class="summary-label">æ•™ç§‘</span><span class="summary-val" id="sum-subject">â€”</span></div>
        <div class="summary-row"><span class="summary-label">ç·´ç¿’å†…å®¹</span><span class="summary-val" id="sum-detail">â€”</span></div>
        <div class="summary-row"><span class="summary-label">ãƒšãƒ¼ã‚¸æ•°</span><span class="summary-val" id="sum-pages">â€”</span></div>
      </div>
      <div class="print-notice">ğŸ’¡ <strong>å°åˆ·ã¯PCãŒãŠã™ã™ã‚ï¼</strong><br>ãƒ‰ãƒªãƒ«ã‚’ä½œã£ãŸã‚ã¨ã€Œã‹ã‚“ã‚Šã‚‡ã†ï¼ã€ã‚’æŠ¼ã™ã¨ãƒ ãƒ‹ã¡ã‚ƒã‚“ãŒè‚²ã¤ã‚ˆğŸ¥š</div>
      <div class="btn-row" style="margin-top:14px;">
        <button class="btn btn-back" onclick="goStep(2)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next btn-print" id="next3" onclick="generateAndPrint()" disabled>ğŸ–¨ï¸ ãƒ‰ãƒªãƒ«ã‚’ä½œã‚‹ï¼</button>
      </div>
      <button class="btn-reset" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>

      <!-- ã‹ã‚“ã‚Šã‚‡ã†ã‚«ãƒ¼ãƒ‰ï¼ˆå°åˆ·å¾Œã«è¡¨ç¤ºï¼‰ -->
      <div class="kanryo-card" id="kanryo-card" style="display:none;">
        <div style="font-size:36px;margin-bottom:8px" id="kanryo-emoji">ğŸ¥š</div>
        <h3>ãƒ‰ãƒªãƒ«ã‚’ã‚„ã‚ŠãŠã‚ã£ãŸã‚‰â€¦</h3>
        <p>å°åˆ·ã—ãŸãƒ‰ãƒªãƒ«ã‚’ã‚„ã‚ŠãŠã‚ã£ãŸã‚‰<br>ãƒ ãƒ‹ã¡ã‚ƒã‚“ã«å ±å‘Šã—ã‚ˆã†ï¼</p>
        <div style="display:flex;gap:8px;margin-bottom:10px;justify-content:center;flex-wrap:wrap" id="kanryo-dtype-grid"></div>
        <button class="btn-kanryo" onclick="handleKanryo()">
          âœ… <span id="kanryo-dtype-label">ã†ã‚“ã´ã¤</span>ã‚’ã‹ã‚“ã‚Šã‚‡ã†ï¼ +XPğŸ‰
        </button>
      </div>
    </div>
  </div>

  <!-- ===== IKUSEI TAB ===== -->
  <div id="tab-ikusei" class="tab-content" style="display:none;">
    <div style="height:12px"></div>
    <div class="creature-card">
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;" id="glow-bg"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="background:linear-gradient(135deg,var(--p),var(--i));color:white;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;">
          ã‚¹ãƒ†ãƒ¼ã‚¸ <span id="i-stage-num">0</span> / 5
        </div>
        <div style="font-size:11px;color:var(--gr);">ğŸ”¥ <span id="i-streak">0</span>ã‚Œã‚“ãã</div>
      </div>
      <div style="text-align:center;position:relative;margin-bottom:8px;">
        <div id="creature-svg-wrap" style="display:inline-block;"></div>
        <div id="levelup-overlay" style="display:none;"></div>
        <div id="particle-layer" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;"></div>
      </div>
      <div style="text-align:center;margin-bottom:10px;">
        <div style="font-size:19px;font-weight:900;color:var(--i);" id="i-stage-name">ã‚¿ãƒã‚´</div>
        <div style="font-size:11px;color:var(--gr);margin-top:2px;" id="i-stage-desc">ã¾ã ä½•ã‹ãŒçœ ã£ã¦ã„ã‚‹â€¦</div>
      </div>
      <div class="xp-bar-wrap">
        <div class="xp-bar-meta">
          <span>ã‘ã„ã‘ã‚“ã¡ <span id="i-xp">0</span> / <span id="i-xp-next">3</span></span>
          <span id="i-xp-rem">ã®ã“ã‚Š 3</span>
        </div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="i-xp-bar" style="width:0%"></div></div>
      </div>
      <div class="stat-grid">
        <div class="stat-item"><div class="stat-icon">ğŸ“„</div><div class="stat-label">ãƒ‰ãƒªãƒ«æ•°</div><div class="stat-val" id="i-total">0ã¾ã„</div></div>
        <div class="stat-item"><div class="stat-icon">â­</div><div class="stat-label">ã‘ã„ã‘ã‚“ã¡</div><div class="stat-val" id="i-xp2">0 XP</div></div>
        <div class="stat-item"><div class="stat-icon">ğŸ…</div><div class="stat-label">ãƒãƒƒã‚¸</div><div class="stat-val" id="i-badge-count">0ã“</div></div>
      </div>
    </div>
    <div style="background:white;border-radius:18px;padding:14px;border:2px solid var(--pm);box-shadow:0 4px 14px rgba(195,104,249,.08);">
      <div style="font-size:13px;font-weight:700;margin-bottom:9px;">ãƒ‰ãƒªãƒ«ã®ã—ã‚…ã‚‹ã„</div>
      <div class="drill-type-grid" id="ikusei-dtype-grid"></div>
      <button onclick="handleKanryo()" style="width:100%;padding:13px;border-radius:30px;border:none;background:linear-gradient(135deg,var(--p),var(--i));color:white;font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 6px 18px rgba(195,104,249,.4);">
        âœ… <span id="ikusei-dtype-label">ã†ã‚“ã´ã¤</span>ã‚’ã‹ã‚“ã‚Šã‚‡ã†ï¼
      </button>
    </div>
  </div>

  <!-- ===== LOG TAB ===== -->
  <div id="tab-log" class="tab-content" style="display:none;">
    <div style="height:12px"></div>
    <div style="font-size:16px;font-weight:900;margin-bottom:13px;">ğŸ“‹ ãã‚ã</div>
    <div id="log-list"><div style="text-align:center;color:var(--gr);padding:40px 0;font-size:13px;">ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“<br>ãƒ‰ãƒªãƒ«ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</div></div>
  </div>

  <!-- ===== BADGES TAB ===== -->
  <div id="tab-badges" class="tab-content" style="display:none;">
    <div style="height:12px"></div>
    <div style="font-size:16px;font-weight:900;margin-bottom:13px;">ğŸ… ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="badge-grid" id="badge-grid"></div>
  </div>
</main>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div class="toast" id="toast" style="display:none;"></div>
<!-- print target -->
<div id="print-target"></div>

<script>
// ===== STAGES & BADGES =====
const STAGES=[
  {id:0,name:"ã‚¿ãƒã‚´",xp:0,desc:"ã¾ã ä½•ã‹ãŒçœ ã£ã¦ã„ã‚‹â€¦",col:"#e8d8ff"},
  {id:1,name:"ãƒ¡ãƒ¡",xp:3,desc:"ç›®ãŒé–‹ã„ãŸï¼å¥½å¥‡å¿ƒæ—ºç››",col:"#d4c0ff"},
  {id:2,name:"ãƒ ãƒ‹",xp:8,desc:"ä½“ãŒç”Ÿãˆã¦ããŸã€‚ã§ã‚“ãã‚Šè¿”ã—ãŒå¥½ã",col:"#c0a8ff"},
  {id:3,name:"ãƒ ãƒ‹ãƒ ãƒ‹",xp:18,desc:"è§¦æ‰‹ãŒå¢—ãˆãŸï¼è¸Šã‚Šå‡ºã—ãŸ",col:"#a888ff"},
  {id:4,name:"ã‚°ãƒ«ã‚°ãƒ«",xp:32,desc:"ç©ºã‚’é£›ã¹ã‚‹ã‚ˆã†ã«ãªã£ãŸï¼",col:"#8860ff"},
  {id:5,name:"ãƒã‚¸ã‚«ãƒ«ãƒ ",xp:50,desc:"å®Œå…¨ä½“ï¼å®‡å®™ã¸æ—…ç«‹ã¤æº–å‚™å®Œäº†",col:"#6633ff"},
];
const BADGES=[
  {id:"first",icon:"ğŸŒŸ",name:"ã¯ã˜ã‚ã®ä¸€æ­©",cond:s=>s.totalDrills>=1},
  {id:"three",icon:"ğŸ”¥",name:"3ã«ã¡ã‚Œã‚“ãã",cond:s=>s.streak>=3},
  {id:"ten",icon:"ğŸ’",name:"10ã¾ã„ãŸã£ã›ã„",cond:s=>s.totalDrills>=10},
  {id:"stage3",icon:"ğŸš€",name:"ã‚¹ãƒ†ãƒ¼ã‚¸3ã¨ã¤ã«ã‚…ã†",cond:s=>s.stage>=3},
  {id:"graduate",icon:"ğŸ‘‘",name:"ãã¤ãã‚‡ã†ï¼",cond:s=>s.stage>=5},
];

// ===== IKUSEI STATE =====
let ikusei={xp:0,stage:0,totalDrills:0,streak:0,log:[],badges:[]};
let currentDrillType="ã†ã‚“ã´ã¤";
let animating=false;

const DRILL_TYPES=["ã†ã‚“ã´ã¤","ã²ã‚‰ãŒãª","ã‹ãš","æ¼¢å­—","ãŸã—ç®—","ã²ãç®—","ä¹ä¹","æ™‚è¨ˆ"];

// ===== SVG CREATURE =====
function creatureSVG(stage,anim){
  const s=stage;
  const floatClass=anim?"creature-bounce":"float-c";
  const styleTag=`<style>
    @keyframes float-c{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes creature-bounce{0%,100%{transform:translateY(0) scale(1,1)}40%{transform:translateY(-18px) scale(.95,1.08)}60%{transform:translateY(-14px) scale(.97,1.05)}}
    @keyframes eyeBlink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}
    @keyframes t1{0%,100%{transform:rotate(0deg)}50%{transform:rotate(12deg)}}
    @keyframes t2{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-12deg)}}
    @keyframes spk{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
    .float-c{animation:float-c 2.8s ease-in-out infinite}
    .creature-bounce{animation:creature-bounce 0.6s ease}
    .ey{animation:eyeBlink 3s infinite;transform-origin:center}
    .ey2{animation:eyeBlink 3s .3s infinite;transform-origin:center}
    .ey3{animation:eyeBlink 3s .5s infinite;transform-origin:center}
    .ta{animation:t1 1.8s ease-in-out infinite}
    .tb{animation:t2 2.1s ease-in-out infinite}
    .tc{animation:t1 1.5s ease-in-out infinite}
    .s1{animation:spk 1.2s ease-in-out infinite}
    .s2{animation:spk 1.5s .4s ease-in-out infinite}
    .s3{animation:spk 1.8s .8s ease-in-out infinite}
  </style>`;
  let inner='';
  if(s===0) inner=`
    <ellipse cx="80" cy="95" rx="38" ry="46" fill="#ede0ff" stroke="#C368F9" stroke-width="2.5"/>
    <ellipse cx="80" cy="95" rx="28" ry="36" fill="white" opacity=".4"/>
    <ellipse cx="68" cy="88" rx="5" ry="6" fill="#C368F9" opacity=".3"/>
    <text x="80" y="102" text-anchor="middle" font-size="22">ğŸ’¤</text>`;
  else if(s===1) inner=`
    <ellipse cx="80" cy="98" rx="36" ry="40" fill="#e0d0ff" stroke="#C368F9" stroke-width="2.5"/>
    <ellipse cx="80" cy="98" rx="26" ry="30" fill="white" opacity=".3"/>
    <g class="ey"><ellipse cx="68" cy="88" rx="9" ry="10" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="70" cy="87" r="5" fill="#876AFF"/><circle cx="71.5" cy="85.5" r="1.8" fill="white"/></g>
    <g class="ey2"><ellipse cx="92" cy="88" rx="9" ry="10" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="94" cy="87" r="5" fill="#876AFF"/><circle cx="95.5" cy="85.5" r="1.8" fill="white"/></g>
    <path d="M74,100 Q80,105 86,100" fill="none" stroke="#C368F9" stroke-width="2" stroke-linecap="round"/>
    <ellipse cx="62" cy="96" rx="6" ry="4" fill="#f0a0d0" opacity=".5"/>
    <ellipse cx="98" cy="96" rx="6" ry="4" fill="#f0a0d0" opacity=".5"/>`;
  else if(s===2) inner=`
    <ellipse cx="80" cy="95" rx="34" ry="38" fill="#d8c4ff" stroke="#C368F9" stroke-width="2.5"/>
    <ellipse cx="80" cy="85" rx="26" ry="28" fill="#ede0ff"/>
    <g class="ey"><ellipse cx="68" cy="80" rx="10" ry="11" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="70" cy="79" r="6" fill="#5533ee"/><circle cx="72" cy="77" r="2" fill="white"/></g>
    <g class="ey2"><ellipse cx="93" cy="80" rx="10" ry="11" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="95" cy="79" r="6" fill="#5533ee"/><circle cx="97" cy="77" r="2" fill="white"/></g>
    <path d="M72,94 Q80,101 88,94" fill="none" stroke="#C368F9" stroke-width="2.5" stroke-linecap="round"/>
    <ellipse cx="59" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".55"/>
    <ellipse cx="101" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".55"/>
    <ellipse cx="65" cy="128" rx="10" ry="6" fill="#c8b0ff"/>
    <ellipse cx="95" cy="128" rx="10" ry="6" fill="#c8b0ff"/>`;
  else if(s===3) inner=`
    <g class="ta" style="transform-origin:65px 118px"><path d="M65,118 Q50,100 45,80 Q42,65 52,58" fill="none" stroke="#a888ff" stroke-width="5" stroke-linecap="round"/><circle cx="52" cy="56" r="6" fill="#C368F9"/></g>
    <g class="tb" style="transform-origin:95px 118px"><path d="M95,118 Q110,100 115,80 Q118,65 108,58" fill="none" stroke="#a888ff" stroke-width="5" stroke-linecap="round"/><circle cx="108" cy="56" r="6" fill="#C368F9"/></g>
    <g class="tc" style="transform-origin:80px 125px"><path d="M80,125 Q72,138 68,148" fill="none" stroke="#a888ff" stroke-width="4" stroke-linecap="round"/><circle cx="67" cy="150" r="5" fill="#876AFF"/><path d="M80,125 Q88,138 92,148" fill="none" stroke="#a888ff" stroke-width="4" stroke-linecap="round"/><circle cx="93" cy="150" r="5" fill="#876AFF"/></g>
    <ellipse cx="80" cy="92" rx="32" ry="34" fill="#c8b0ff" stroke="#876AFF" stroke-width="2.5"/>
    <ellipse cx="80" cy="84" rx="24" ry="25" fill="#ddd0ff"/>
    <g class="ey"><ellipse cx="67" cy="79" rx="11" ry="12" fill="white" stroke="#6644cc" stroke-width="1.5"/><circle cx="69" cy="78" r="7" fill="#4422bb"/><circle cx="71" cy="76" r="2.5" fill="white"/></g>
    <g class="ey2"><ellipse cx="93" cy="79" rx="11" ry="12" fill="white" stroke="#6644cc" stroke-width="1.5"/><circle cx="95" cy="78" r="7" fill="#4422bb"/><circle cx="97" cy="76" r="2.5" fill="white"/></g>
    <path d="M70,96 Q80,104 90,96" fill="none" stroke="#7744cc" stroke-width="2.5" stroke-linecap="round"/>
    <ellipse cx="61" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".6"/>
    <ellipse cx="99" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".6"/>`;
  else if(s===4) inner=`
    <ellipse cx="80" cy="90" rx="62" ry="14" fill="none" stroke="#C368F9" stroke-width="3" opacity=".4"/>
    <ellipse cx="80" cy="90" rx="52" ry="10" fill="none" stroke="#876AFF" stroke-width="2" opacity=".5"/>
    <g class="ta" style="transform-origin:55px 105px"><path d="M55,105 Q38,78 32,60" fill="none" stroke="#8855ee" stroke-width="4.5" stroke-linecap="round"/><circle cx="32" cy="60" r="6" fill="#C368F9"/></g>
    <g class="tb" style="transform-origin:105px 105px"><path d="M105,105 Q122,78 128,60" fill="none" stroke="#8855ee" stroke-width="4.5" stroke-linecap="round"/><circle cx="128" cy="60" r="6" fill="#C368F9"/></g>
    <g class="tc" style="transform-origin:62px 120px"><path d="M62,120 Q50,140 46,155" fill="none" stroke="#8855ee" stroke-width="4" stroke-linecap="round"/><circle cx="46" cy="155" r="6" fill="#876AFF"/></g>
    <g class="ta" style="transform-origin:98px 120px"><path d="M98,120 Q110,140 114,155" fill="none" stroke="#8855ee" stroke-width="4" stroke-linecap="round"/><circle cx="114" cy="155" r="6" fill="#876AFF"/></g>
    <ellipse cx="80" cy="88" rx="30" ry="32" fill="#b898ff" stroke="#7744ee" stroke-width="2.5"/>
    <ellipse cx="80" cy="80" rx="22" ry="23" fill="#ccc0ff"/>
    <g class="ey"><ellipse cx="67" cy="75" rx="11" ry="13" fill="white" stroke="#5533cc" stroke-width="1.5"/><circle cx="69" cy="74" r="7.5" fill="#3311aa"/><circle cx="71" cy="72" r="2.5" fill="white"/></g>
    <g class="ey2"><ellipse cx="93" cy="75" rx="11" ry="13" fill="white" stroke="#5533cc" stroke-width="1.5"/><circle cx="95" cy="74" r="7.5" fill="#3311aa"/><circle cx="97" cy="72" r="2.5" fill="white"/></g>
    <path d="M70,92 Q80,101 90,92" fill="#9966ff" stroke="#5533cc" stroke-width="1.5" stroke-linecap="round"/>
    <ellipse cx="59" cy="86" rx="7" ry="5" fill="#f080c8" opacity=".65"/>
    <ellipse cx="101" cy="86" rx="7" ry="5" fill="#f080c8" opacity=".65"/>
    <g class="s1"><text x="22" y="55" font-size="14">âœ¨</text></g>
    <g class="s2"><text x="120" y="50" font-size="12">â­</text></g>
    <g class="s3"><text x="130" y="100" font-size="10">ğŸ’«</text></g>`;
  else inner=`
    ${[0,30,60,90,120,150,180,210,240,270,300,330].map(a=>`<line x1="${80+28*Math.cos(a*Math.PI/180)}" y1="${70+28*Math.sin(a*Math.PI/180)}" x2="${80+42*Math.cos(a*Math.PI/180)}" y2="${70+42*Math.sin(a*Math.PI/180)}" stroke="#f5c800" stroke-width="2" opacity=".7"/>`).join('')}
    <circle cx="80" cy="70" r="24" fill="#ffe060" opacity=".3"/>
    <g class="ta" style="transform-origin:55px 108px"><path d="M55,108 Q35,82 26,62" fill="none" stroke="#C368F9" stroke-width="5" stroke-linecap="round"/><circle cx="26" cy="62" r="7" fill="#a044ee"/></g>
    <g class="tb" style="transform-origin:105px 108px"><path d="M105,108 Q125,82 134,62" fill="none" stroke="#876AFF" stroke-width="5" stroke-linecap="round"/><circle cx="134" cy="62" r="7" fill="#6644ff"/></g>
    <g class="tc" style="transform-origin:58px 118px"><path d="M58,118 Q44,140 38,158" fill="none" stroke="#60E2B7" stroke-width="5" stroke-linecap="round"/><circle cx="38" cy="158" r="7" fill="#30c890"/></g>
    <g class="ta" style="transform-origin:102px 118px"><path d="M102,118 Q116,140 122,158" fill="none" stroke="#C368F9" stroke-width="5" stroke-linecap="round"/><circle cx="122" cy="158" r="7" fill="#C368F9"/></g>
    <g class="tb" style="transform-origin:68px 122px"><path d="M68,122 Q58,145 55,160" fill="none" stroke="#f5c800" stroke-width="4" stroke-linecap="round"/><circle cx="55" cy="160" r="6" fill="#f5a000"/></g>
    <g class="tc" style="transform-origin:92px 122px"><path d="M92,122 Q102,145 105,160" fill="none" stroke="#876AFF" stroke-width="4" stroke-linecap="round"/><circle cx="105" cy="160" r="6" fill="#5522ff"/></g>
    <ellipse cx="80" cy="88" rx="30" ry="32" fill="url(#rg5)" stroke="#6633ff" stroke-width="3"/>
    <defs><radialGradient id="rg5" cx="40%" cy="35%"><stop offset="0%" stop-color="#f0e0ff"/><stop offset="100%" stop-color="#9966ff"/></radialGradient></defs>
    <path d="M62,66 L66,56 L72,63 L80,52 L88,63 L94,56 L98,66 Z" fill="#f5c800" stroke="#e0a000" stroke-width="1.5"/>
    <g class="ey"><ellipse cx="67" cy="77" rx="11" ry="13" fill="white" stroke="#4400cc" stroke-width="2"/><text x="67" y="82" text-anchor="middle" font-size="14">â­</text></g>
    <g class="ey2"><ellipse cx="93" cy="77" rx="11" ry="13" fill="white" stroke="#4400cc" stroke-width="2"/><text x="93" y="82" text-anchor="middle" font-size="14">â­</text></g>
    <path d="M70,95 Q80,104 90,95" fill="#cc88ff" stroke="#6600cc" stroke-width="2" stroke-linecap="round"/>
    <ellipse cx="59" cy="86" rx="8" ry="5.5" fill="#ff88cc" opacity=".7"/>
    <ellipse cx="101" cy="86" rx="8" ry="5.5" fill="#ff88cc" opacity=".7"/>
    <g class="s1"><text x="15" y="38" font-size="13">âœ¨</text></g>
    <g class="s2"><text x="135" y="32" font-size="12">â­</text></g>
    <g class="s3"><text x="18" y="120" font-size="12">ğŸ’«</text></g>
    <g class="s1"><text x="132" y="115" font-size="11">ğŸŒŸ</text></g>`;

  return `<svg viewBox="0 0 160 160" width="160" height="160" style="overflow:visible">${styleTag}<g class="${floatClass}">${inner}</g></svg>`;
}

function renderCreature(anim=false){
  const w=document.getElementById('creature-svg-wrap');
  if(w) w.innerHTML=creatureSVG(ikusei.stage,anim);
}

function updateIkuseiUI(){
  const s=STAGES[ikusei.stage];
  const nxt=STAGES[Math.min(ikusei.stage+1,STAGES.length-1)];
  const maxed=ikusei.stage>=STAGES.length-1;
  const needed=nxt.xp-s.xp;
  const prog=maxed?100:Math.min(100,((ikusei.xp-s.xp)/needed)*100);

  document.getElementById('i-stage-num').textContent=ikusei.stage;
  document.getElementById('i-streak').textContent=ikusei.streak;
  document.getElementById('i-stage-name').textContent=s.name;
  document.getElementById('i-stage-desc').textContent=s.desc;
  document.getElementById('i-xp').textContent=ikusei.xp;
  document.getElementById('i-xp2').textContent=ikusei.xp+' XP';
  document.getElementById('i-xp-next').textContent=maxed?'MAX':nxt.xp;
  document.getElementById('i-xp-rem').textContent=maxed?'ğŸ‰ ã‹ã‚“ã›ã„ï¼':'ã®ã“ã‚Š '+(nxt.xp-ikusei.xp);
  document.getElementById('i-xp-bar').style.width=prog+'%';
  document.getElementById('i-total').textContent=ikusei.totalDrills+'ã¾ã„';
  document.getElementById('i-badge-count').textContent=ikusei.badges.length+'ã“';
  document.getElementById('glow-bg').style.background=`radial-gradient(ellipse at 50% 40%, ${s.col}44, transparent 70%)`;

  // ã‹ã‚“ã‚Šã‚‡ã†ã‚«ãƒ¼ãƒ‰ã®emojiæ›´æ–°
  const kanEm=document.getElementById('kanryo-emoji');
  if(kanEm) kanEm.textContent=['ğŸ¥š','ğŸ‘€','ğŸŸ£','ğŸ¦‘','ğŸŒ€','ğŸ‘‘'][ikusei.stage]||'ğŸ¥š';
}

function renderDrillTypes(){
  ['kanryo-dtype-grid','ikusei-dtype-grid'].forEach(id=>{
    const g=document.getElementById(id); if(!g) return;
    g.innerHTML='';
    DRILL_TYPES.forEach(t=>{
      const b=document.createElement('button');
      b.className='dtype-btn';
      b.textContent=t;
      b.dataset.type=t;
      b.style.borderColor=t===currentDrillType?'#C368F9':'#e4d8f8';
      b.style.background=t===currentDrillType?'#f8eeff':'white';
      b.style.color=t===currentDrillType?'#C368F9':'#8878a0';
      b.style.fontWeight=t===currentDrillType?'700':'400';
      b.onclick=()=>{
        currentDrillType=t;
        renderDrillTypes();
        ['kanryo-dtype-label','ikusei-dtype-label'].forEach(i=>{const el=document.getElementById(i);if(el) el.textContent=t;});
      };
      g.appendChild(b);
    });
  });
}

function handleKanryo(){
  const gain=Math.floor(Math.random()*2)+1;
  const prevStage=ikusei.stage;
  ikusei.xp+=gain;
  ikusei.totalDrills++;
  ikusei.streak++;

  // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
  const newStage=[...STAGES].reverse().find(s=>ikusei.xp>=s.xp)?.id??0;
  const leveled=newStage>prevStage;
  if(leveled){ ikusei.stage=newStage; renderCreature(true); showLevelUp(STAGES[newStage]); }
  else { renderCreature(true); setTimeout(()=>renderCreature(false),700); }

  // ãƒ­ã‚°è¿½åŠ 
  const now=new Date();
  ikusei.log.unshift({
    date:`${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`,
    type:currentDrillType, xp:gain, stageName:STAGES[ikusei.stage].name
  });
  if(ikusei.log.length>30) ikusei.log.pop();

  // ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
  checkBadges();
  updateIkuseiUI();
  renderLog();
  renderBadges();
  spawnParticles();
  showToast(`+${gain}XP ã‚²ãƒƒãƒˆï¼ãƒ ãƒ‹ã¡ã‚ƒã‚“ã«å±Šã„ãŸâœ¨`);

  // ikuseiã‚¿ãƒ–ã¸èª˜å°
  setTimeout(()=>switchTab('ikusei'),800);
}

function checkBadges(){
  BADGES.forEach(b=>{
    if(!ikusei.badges.includes(b.id)&&b.cond({totalDrills:ikusei.totalDrills,streak:ikusei.streak,stage:ikusei.stage})){
      ikusei.badges.push(b.id);
      setTimeout(()=>showToast(`${b.icon} ãƒãƒƒã‚¸ã‚²ãƒƒãƒˆï¼ã€Œ${b.name}ã€`),1200);
    }
  });
}

function showLevelUp(stageInfo){
  const el=document.getElementById('levelup-overlay');
  el.style.display='block';
  el.innerHTML=`<div style="font-size:22px;">ğŸ‰</div><div style="font-size:13px;font-weight:900;color:#C368F9;">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ï¼</div><div style="font-size:16px;font-weight:900;color:#876AFF;">ã€Œ${stageInfo.name}ã€ã«ãªã£ãŸï¼</div>`;
  el.className='levelup-overlay';
  setTimeout(()=>{el.style.display='none';renderCreature(false);},2600);
}

function spawnParticles(){
  const layer=document.getElementById('particle-layer');
  const emojis=['â­','âœ¨','ğŸ’«','ğŸŒŸ','ğŸ’œ'];
  layer.innerHTML='';
  for(let i=0;i<8;i++){
    const span=document.createElement('span');
    span.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    span.style.cssText=`position:absolute;font-size:18px;left:${20+Math.random()*120}px;top:${40+Math.random()*80}px;animation:particleFly .9s ease-out forwards;pointer-events:none;`;
    layer.appendChild(span);
  }
  setTimeout(()=>layer.innerHTML='',1000);
}

let toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.display='block';
  t.style.animation='none'; t.offsetHeight; t.style.animation='slideUp .4s cubic-bezier(.4,2,.6,1)';
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.style.display='none',2200);
}

function renderLog(){
  const el=document.getElementById('log-list');
  if(ikusei.log.length===0){el.innerHTML='<div style="text-align:center;color:#8878a0;padding:40px 0;font-size:13px;">ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“<br>ãƒ‰ãƒªãƒ«ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</div>';return;}
  el.innerHTML=ikusei.log.map(l=>`
    <div class="log-item">
      <div class="log-icon">ğŸ“„</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:700">${l.type}</div><div style="font-size:11px;color:#8878a0;margin-top:1px">${l.date} Â· ${l.stageName}</div></div>
      <div style="background:#f8eeff;color:#C368F9;border-radius:99px;padding:3px 9px;font-size:12px;font-weight:700">+${l.xp}XP</div>
    </div>`).join('');
}

function renderBadges(){
  const el=document.getElementById('badge-grid');
  el.innerHTML=BADGES.map(b=>{
    const earned=ikusei.badges.includes(b.id);
    return `<div class="badge-item ${earned?'earned':'locked'}">
      <div style="font-size:34px;filter:${earned?'none':'grayscale(1)'}">${b.icon}</div>
      <div style="font-size:12px;font-weight:700;color:${earned?'#876AFF':'#888'};margin-top:5px">${b.name}</div>
      <div style="font-size:10px;margin-top:2px;color:${earned?'#C368F9':'#aaa'}">${earned?'ã‚²ãƒƒãƒˆï¼':'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
    </div>`;
  }).join('');
}

// ===== TAB SWITCH =====
function switchTab(tab){
  ['drill','ikusei','log','badges'].forEach(t=>{
    document.getElementById('tab-'+t).style.display=t===tab?'block':'none';
    document.getElementById('nav-'+t).classList.toggle('act',t===tab);
  });
  if(tab==='ikusei') renderCreature(false);
  if(tab==='log') renderLog();
  if(tab==='badges') renderBadges();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ===== DRILL STATE =====
const dstate={age:'',subject:[],detail:[],pages:''};
const stepLabels=['STEP 1/4 â€” ã ã‚Œã®ãƒ‰ãƒªãƒ«ï¼Ÿ','STEP 2/4 â€” æ•™ç§‘ã‚’é¸ã¼ã†','STEP 3/4 â€” ç¨®é¡ã‚’é¸ã¼ã†','STEP 4/4 â€” ãƒšãƒ¼ã‚¸æ•°ãƒ»ç¢ºèª'];
const ageLabel={yoji2:'2ã€œ3æ­³',yoji4:'4ã€œ5æ­³',yoji6:'å¹´é•·ï¼ˆ5ã€œ6æ­³ï¼‰',sho1:'å°å­¦1å¹´ç”Ÿ',sho2:'å°å­¦2å¹´ç”Ÿ',sho3:'å°å­¦3å¹´ç”Ÿ'};
const sbjLabel={unpitsu:'ã†ã‚“ã´ã¤',hiragana:'ã²ã‚‰ãŒãª',kotoba:'ã“ã¨ã°',kazu:'ã‹ãš',kanji1:'æ¼¢å­—(1å¹´)',kanji2:'æ¼¢å­—(2å¹´)',kanji3:'æ¼¢å­—(3å¹´)',tasizan:'ãŸã—ç®—',hikizan:'ã²ãç®—',tokei:'æ™‚è¨ˆ',tasizan2:'ãŸã—ç®—',hikizan2:'ã²ãç®—',kuku:'ä¹ä¹',tokei2:'æ™‚è¨ˆ',kakezan:'ã‹ã‘ç®—',warizan:'ã‚ã‚Šç®—',masu:'ãƒã‚¹è¨ˆç®—'};
const subjectsByAge={
  yoji2:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šãƒ»ãªãã‚Š'}],
  yoji4:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šãƒ»ãªãã‚Š'},{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'ã‚ˆã¿ãƒ»ã“ã¨ã°'},{val:'kazu',icon:'ğŸ”¢',label:'ã‹ãš',desc:'æ•°ã®ç·´ç¿’'}],
  yoji6:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šãƒ»ãªãã‚Š'},{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'ã‚ˆã¿ãƒ»æ›¸ã'},{val:'kotoba',icon:'ğŸ’¬',label:'ã“ã¨ã°',desc:'èªå½™ãƒ»æ–‡ç« '},{val:'kazu',icon:'ğŸ”¢',label:'ã‹ãš',desc:'1ã€œ20ãƒ»å½¢'}],
  sho1:[{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'èª­ã¿æ›¸ã'},{val:'kanji1',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ1å¹´ï¼‰',desc:'80å­—'},{val:'tasizan',icon:'â•',label:'ãŸã—ç®—',desc:'1æ¡'},{val:'hikizan',icon:'â–',label:'ã²ãç®—',desc:'1æ¡'},{val:'tokei',icon:'ğŸ•',label:'æ™‚è¨ˆ',desc:'ä½•æ™‚ãƒ»åŠ'}],
  sho2:[{val:'kanji2',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ2å¹´ï¼‰',desc:'160å­—'},{val:'tasizan2',icon:'â•',label:'ãŸã—ç®—',desc:'2æ¡'},{val:'hikizan2',icon:'â–',label:'ã²ãç®—',desc:'2æ¡'},{val:'kuku',icon:'âœ–ï¸',label:'ä¹ä¹',desc:'2ã€œ9æ®µ'},{val:'tokei2',icon:'ğŸ•',label:'æ™‚è¨ˆ',desc:'ä½•æ™‚ä½•åˆ†'}],
  sho3:[{val:'kanji3',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ3å¹´ï¼‰',desc:'200å­—'},{val:'kakezan',icon:'âœ–ï¸',label:'ã‹ã‘ç®—',desc:'2ãƒ»3æ¡'},{val:'warizan',icon:'â—',label:'ã‚ã‚Šç®—',desc:'ã‚ã¾ã‚Šãªã—'},{val:'masu',icon:'ğŸ”²',label:'ãƒã‚¹è¨ˆç®—',desc:'ãŸã—ãƒ»ã²ã'}],
};
const detailsBySubject={
  unpitsu:[{val:'yoko',icon:'â¡ï¸',label:'æ¨ªç·š'},{val:'tate',icon:'â¬‡ï¸',label:'ç¸¦ç·š'},{val:'nami',icon:'ğŸŒŠ',label:'æ³¢ç·š'},{val:'zag',icon:'âš¡',label:'ã‚¸ã‚°ã‚¶ã‚°'}],
  hiragana:[{val:'dobutsu',icon:'ğŸ¶',label:'ã©ã†ã¶ã¤'},{val:'tabemono',icon:'ğŸ',label:'ãŸã¹ã‚‚ã®'},{val:'norimono',icon:'ğŸšŒ',label:'ã®ã‚Šã‚‚ã®'},{val:'shizen',icon:'ğŸŒ¸',label:'ã—ãœã‚“'}],
  kotoba:[{val:'dobutsu',icon:'ğŸ¶',label:'ã©ã†ã¶ã¤'},{val:'tabemono',icon:'ğŸ',label:'ãŸã¹ã‚‚ã®'}],
  kazu:[{val:'k1_5',icon:'ğŸ–ï¸',label:'1ã€œ5'},{val:'k1_10',icon:'ğŸ”Ÿ',label:'1ã€œ10'},{val:'tasu_k',icon:'â•',label:'ãŸã—ã–ã‚“'}],
  kanji1:[{val:'kanji1a',icon:'å±±',label:'è‡ªç„¶ãƒ»ä½“'},{val:'kanji1b',icon:'ä¸€',label:'æ•°ãƒ»é‡'},{val:'kanji1c',icon:'æ—¥',label:'æ—¥ãƒ»æœˆãƒ»å¹´'}],
  kanji2:[{val:'kanji2a',icon:'æ˜¥',label:'å­£ç¯€'},{val:'kanji2b',icon:'æ±',label:'æ–¹è§’'},{val:'kanji2c',icon:'è¦ª',label:'å®¶æ—'}],
  kanji3:[{val:'kanji3a',icon:'æ—',label:'ç”Ÿæ´»'},{val:'kanji3b',icon:'è¾²',label:'è‡ªç„¶ãƒ»ç”£æ¥­'}],
  tasizan:[{val:'tasu1',icon:'â•',label:'ãã‚Šä¸ŠãŒã‚Šãªã—'},{val:'tasu2',icon:'â•',label:'ãã‚Šä¸ŠãŒã‚Š'}],
  hikizan:[{val:'hiki1',icon:'â–',label:'ãã‚Šä¸‹ãŒã‚Šãªã—'},{val:'hiki2',icon:'â–',label:'ãã‚Šä¸‹ãŒã‚Š'}],
  tokei:[{val:'tokei_h',icon:'ğŸ•',label:'ä½•æ™‚'},{val:'tokei_hh',icon:'ğŸ•§',label:'ä½•æ™‚åŠ'}],
  tasizan2:[{val:'tasu2a',icon:'â•',label:'2æ¡+1æ¡'},{val:'tasu2b',icon:'â•',label:'2æ¡+2æ¡'}],
  hikizan2:[{val:'hiki2a',icon:'â–',label:'2æ¡-1æ¡'},{val:'hiki2b',icon:'â–',label:'2æ¡-2æ¡'}],
  kuku:[{val:'kuku2',icon:'âœ–ï¸',label:'2ã€œ4æ®µ'},{val:'kuku5',icon:'âœ–ï¸',label:'5ã€œ7æ®µ'},{val:'kuku8',icon:'âœ–ï¸',label:'8ã€œ9æ®µ'}],
  tokei2:[{val:'tokei_min',icon:'ğŸ•',label:'ä½•æ™‚ä½•åˆ†'},{val:'tokei_all',icon:'ğŸ•',label:'çµŒéæ™‚é–“'}],
  kakezan:[{val:'kake2',icon:'âœ–ï¸',label:'2æ¡Ã—1æ¡'},{val:'kake3',icon:'âœ–ï¸',label:'3æ¡Ã—1æ¡'}],
  warizan:[{val:'wari1',icon:'â—',label:'Ã·1æ¡'}],
  masu:[{val:'masu_tasu',icon:'ï¼‹',label:'ãŸã—ç®—ãƒã‚¹'},{val:'masu_hiki',icon:'ï¼',label:'ã²ãç®—ãƒã‚¹'}],
};
const detailNames={yoko:'æ¨ªç·š',tate:'ç¸¦ç·š',nami:'æ³¢ç·š',zag:'ã‚¸ã‚°ã‚¶ã‚°',dobutsu:'ã©ã†ã¶ã¤',tabemono:'ãŸã¹ã‚‚ã®',norimono:'ã®ã‚Šã‚‚ã®',shizen:'ã—ãœã‚“',k1_5:'1ã€œ5',k1_10:'1ã€œ10',tasu_k:'ãŸã—ã–ã‚“',kanji1a:'è‡ªç„¶ãƒ»ä½“',kanji1b:'æ•°ãƒ»é‡',kanji1c:'æ—¥ãƒ»æœˆãƒ»å¹´',kanji2a:'å­£ç¯€',kanji2b:'æ–¹è§’',kanji2c:'å®¶æ—',kanji3a:'ç”Ÿæ´»',kanji3b:'è‡ªç„¶',tasu1:'1æ¡ãŸã—ç®—',tasu2:'ãã‚Šä¸ŠãŒã‚Š',hiki1:'1æ¡ã²ãç®—',hiki2:'ãã‚Šä¸‹ãŒã‚Š',tokei_h:'ä½•æ™‚',tokei_hh:'ä½•æ™‚åŠ',tasu2a:'2æ¡+1æ¡',tasu2b:'2æ¡+2æ¡',hiki2a:'2æ¡-1æ¡',hiki2b:'2æ¡-2æ¡',kuku2:'2ã€œ4æ®µ',kuku5:'5ã€œ7æ®µ',kuku8:'8ã€œ9æ®µ',tokei_min:'ä½•æ™‚ä½•åˆ†',tokei_all:'çµŒéæ™‚é–“',kake2:'2æ¡Ã—1æ¡',kake3:'3æ¡Ã—1æ¡',wari1:'Ã·1æ¡',masu_tasu:'ãŸã—ç®—ãƒã‚¹',masu_hiki:'ã²ãç®—ãƒã‚¹'};

function selectOne(el,key){
  el.closest('[class*="card-grid"]').querySelectorAll('.choice-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected'); dstate[key]=el.dataset.val;
  if(key==='age') buildSubjectGrid();
  if(key==='pages') updateSummary();
  updateNextBtn();
}
function selectMulti(el,key){
  el.classList.toggle('selected');
  const vals=[...el.closest('[class*="card-grid"]').querySelectorAll('.choice-card.selected')].map(c=>c.dataset.val);
  dstate[key]=vals;
  if(key==='subject') buildDetailGrid();
  updateNextBtn(); updateSummary();
}
function updateNextBtn(){
  document.getElementById('next0').disabled=!dstate.age;
  document.getElementById('next1').disabled=dstate.subject.length===0;
  document.getElementById('next2').disabled=dstate.detail.length===0;
  document.getElementById('next3').disabled=!dstate.pages;
}
function goStep(n){
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.prog-dot').forEach((d,i)=>{d.classList.toggle('done',i<n);d.classList.toggle('active',i===n);});
  document.getElementById('prog-label').textContent=stepLabels[n];
  if(n===3) updateSummary();
  window.scrollTo({top:0,behavior:'smooth'});
}
function buildSubjectGrid(){
  const g=document.getElementById('subject-grid');
  g.innerHTML=''; dstate.subject=[];
  (subjectsByAge[dstate.age]||[]).forEach(opt=>{
    const d=document.createElement('div');
    d.className='choice-card'; d.dataset.val=opt.val;
    d.innerHTML=`<div class="checkmark"></div><div class="icon">${opt.icon}</div><div class="label">${opt.label}</div><div class="desc">${opt.desc||''}</div>`;
    d.onclick=()=>selectMulti(d,'subject');
    g.appendChild(d);
  });
  updateNextBtn();
}
function buildDetailGrid(){
  const g=document.getElementById('detail-grid');
  g.innerHTML=''; dstate.detail=[];
  dstate.subject.forEach(sub=>{
    const opts=detailsBySubject[sub]; if(!opts) return;
    const h=document.createElement('div');
    h.className='section-label'; h.textContent='â–¸ '+(sbjLabel[sub]||sub)+'ã®ç¨®é¡';
    g.appendChild(h);
    opts.forEach(opt=>{
      const d=document.createElement('div');
      d.className='choice-card'; d.dataset.val=opt.val;
      d.innerHTML=`<div class="checkmark"></div><div class="icon">${opt.icon}</div><div class="label">${opt.label}</div>`;
      d.onclick=()=>{d.classList.toggle('selected');dstate.detail=[...g.querySelectorAll('.choice-card.selected')].map(c=>c.dataset.val);updateNextBtn();updateSummary();};
      g.appendChild(d);
    });
  });
  updateNextBtn();
}
function updateSummary(){
  document.getElementById('sum-age').textContent=ageLabel[dstate.age]||'â€”';
  document.getElementById('sum-subject').textContent=dstate.subject.map(s=>sbjLabel[s]||s).join('ãƒ»')||'â€”';
  document.getElementById('sum-detail').textContent=dstate.detail.map(d=>detailNames[d]||d).join('ãƒ»')||'â€”';
  document.getElementById('sum-pages').textContent=dstate.pages?dstate.pages+'æš':'â€”';
  // ã‹ã‚“ã‚Šã‚‡ã†ã‚«ãƒ¼ãƒ‰ã®ãƒ‰ãƒªãƒ«ã‚¿ã‚¤ãƒ—å€™è£œã‚’è¨­å®š
  const dtype=dstate.subject.length>0?(sbjLabel[dstate.subject[0]]||'ã†ã‚“ã´ã¤'):'ã†ã‚“ã´ã¤';
  currentDrillType=dtype;
  ['kanryo-dtype-label','ikusei-dtype-label'].forEach(i=>{const el=document.getElementById(i);if(el)el.textContent=dtype;});
  renderDrillTypes();
}
function resetAll(){
  dstate.age='';dstate.subject=[];dstate.detail=[];dstate.pages='';
  document.querySelectorAll('.choice-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('kanryo-card').style.display='none';
  goStep(0); updateNextBtn();
}

// ===== DRILL CONTENT GENERATION =====
const OM_BASE='https://cdn.jsdelivr.net/gh/hfg-gmuend/openmoji/color/svg/';
const OM={dog:'1F436',cat:'1F431',bear:'1F43B',rabbit:'1F430',elephant:'1F418',monkey:'1F412',tiger:'1F42F',fox:'1F98A',apple:'1F34E',banana:'1F34C',strawberry:'1F353',grapes:'1F347',peach:'1F351',orange:'1F34A',watermelon:'1F349',melon:'1F348',bus:'1F68C',train:'1F683',car:'1F697',airplane:'2708',ship:'1F6A2',bicycle:'1F6B2',shinkansen:'1F685',taxi:'1F695',cherry_blossom:'1F338',cloud:'2601',mountain:'26F0',ocean:'1F30A',mushroom:'1F344',star:'2B50',moon:'1F319',wind:'1F32C',fish:'1F41F',dolphin:'1F42C',octopus:'1F419',tropical_fish:'1F420',frog:'1F438',rooster:'1F413',chick:'1F425',truck:'1F69B',lightning:'26A1'};
function omImg(hex,cls='om'){return `<img src="${OM_BASE}${hex.toUpperCase()}.svg" class="${cls}" loading="lazy" onerror="this.style.visibility='hidden'">`;}
const kokugoThemes={
  dobutsu:[{word:'ã„ã¬',hex:OM.dog,bg:'#ede0ff'},{word:'ã­ã“',hex:OM.cat,bg:'#e0edff'},{word:'ãã¾',hex:OM.bear,bg:'#e0ffe8'},{word:'ã†ã•ã',hex:OM.rabbit,bg:'#fff0e0'},{word:'ãã†',hex:OM.elephant,bg:'#e8e0ff'},{word:'ã•ã‚‹',hex:OM.monkey,bg:'#e0f4ff'},{word:'ã¨ã‚‰',hex:OM.tiger,bg:'#fff8e0'},{word:'ãã¤ã­',hex:OM.fox,bg:'#ffe8e0'}],
  tabemono:[{word:'ã‚Šã‚“ã”',hex:OM.apple,bg:'#ffe0e8'},{word:'ãƒãƒŠãƒŠ',hex:OM.banana,bg:'#fffde0'},{word:'ã„ã¡ã”',hex:OM.strawberry,bg:'#e0ffe8'},{word:'ã¶ã©ã†',hex:OM.grapes,bg:'#ede0ff'},{word:'ã‚‚ã‚‚',hex:OM.peach,bg:'#ffe8e0'},{word:'ã¿ã‹ã‚“',hex:OM.orange,bg:'#fff4e0'},{word:'ã™ã„ã‹',hex:OM.watermelon,bg:'#e0fff4'},{word:'ãƒ¡ãƒ­ãƒ³',hex:OM.melon,bg:'#e8ffe0'}],
  norimono:[{word:'ãƒã‚¹',hex:OM.bus,bg:'#e0f0ff'},{word:'ã§ã‚“ã—ã‚ƒ',hex:OM.train,bg:'#e0e8ff'},{word:'ãã‚‹ã¾',hex:OM.car,bg:'#fff4e0'},{word:'ã²ã“ã†ã',hex:OM.airplane,bg:'#e8f8ff'},{word:'ãµã­',hex:OM.ship,bg:'#e0f8ff'},{word:'ã˜ã¦ã‚“ã—ã‚ƒ',hex:OM.bicycle,bg:'#e8ffe0'},{word:'ã—ã‚“ã‹ã‚“ã›ã‚“',hex:OM.shinkansen,bg:'#ede0ff'},{word:'ã‚¿ã‚¯ã‚·ãƒ¼',hex:OM.taxi,bg:'#fffde0'}],
  shizen:[{word:'ã¯ãª',hex:OM.cherry_blossom,bg:'#ffe0ed'},{word:'ãã‚‰',hex:OM.cloud,bg:'#e0f4ff'},{word:'ã‚„ã¾',hex:OM.mountain,bg:'#e8ffe0'},{word:'ã†ã¿',hex:OM.ocean,bg:'#e0f8ff'},{word:'ãã®ã“',hex:OM.mushroom,bg:'#ffe8e0'},{word:'ã»ã—',hex:OM.star,bg:'#fffde0'},{word:'ã¤ã',hex:OM.moon,bg:'#ede0ff'},{word:'ã‹ãœ',hex:OM.wind,bg:'#e0faff'}],
};
const kanjiData={
  kanji1a:[{char:'å±±',read:'ã‚„ã¾',ex:'å±±ãƒ»å±±é“'},{char:'å·',read:'ã‹ã‚',ex:'å·ãƒ»å·è¾º'},{char:'æœ¨',read:'ã',ex:'æœ¨ãƒ»æœ¨ã®è‘‰'},{char:'ç«',read:'ã²',ex:'ç«ãƒ»ç«å±±'},{char:'æ°´',read:'ã¿ãš',ex:'æ°´ãƒ»æ°´é“'},{char:'åœŸ',read:'ã¤ã¡',ex:'åœŸãƒ»åœŸåœ°'},{char:'ç©º',read:'ãã‚‰',ex:'ç©ºãƒ»é’ç©º'},{char:'èŠ±',read:'ã¯ãª',ex:'èŠ±ãƒ»èŠ±ç•‘'}],
  kanji1b:[{char:'ä¸€',read:'ã„ã¡',ex:'ä¸€ã¤ãƒ»ä¸€ç•ª'},{char:'äºŒ',read:'ã«',ex:'äºŒã¤ãƒ»äºŒå›'},{char:'ä¸‰',read:'ã•ã‚“',ex:'ä¸‰ã¤ãƒ»ä¸‰è§’'},{char:'å››',read:'ã—',ex:'å››ã¤ãƒ»å››æ–¹'},{char:'äº”',read:'ã”',ex:'äº”ã¤ãƒ»äº”æœˆ'},{char:'å…­',read:'ã‚ã',ex:'å…­ã¤ãƒ»å…­æœˆ'},{char:'ä¸ƒ',read:'ãªãª',ex:'ä¸ƒã¤ãƒ»ä¸ƒå¤•'},{char:'å…«',read:'ã¯ã¡',ex:'å…«ã¤ãƒ»å…«æœˆ'}],
  kanji1c:[{char:'æ—¥',read:'ã«ã¡',ex:'ä»Šæ—¥ãƒ»æ—¥æœ¬'},{char:'æœˆ',read:'ã¤ã',ex:'æœˆãƒ»æœˆæ›œ'},{char:'å¹´',read:'ã­ã‚“',ex:'ä»Šå¹´ãƒ»ä¸€å¹´'},{char:'æ™‚',read:'ã¨ã',ex:'æ™‚é–“ãƒ»ä¸€æ™‚'},{char:'åˆ†',read:'ãµã‚“',ex:'ååˆ†ãƒ»ä¸€åˆ†'},{char:'ä¸Š',read:'ã†ãˆ',ex:'ä¸Šãƒ»ä¸Šæ‰‹'},{char:'ä¸‹',read:'ã—ãŸ',ex:'ä¸‹ãƒ»ä¸‹æ‰‹'},{char:'ä¸­',read:'ãªã‹',ex:'ä¸­ãƒ»ä¸­å¿ƒ'}],
  kanji2a:[{char:'æ˜¥',read:'ã¯ã‚‹',ex:'æ˜¥é¢¨ãƒ»æ˜¥ä¼‘ã¿'},{char:'å¤',read:'ãªã¤',ex:'å¤ç©ºãƒ»å¤ä¼‘ã¿'},{char:'ç§‹',read:'ã‚ã',ex:'ç§‹ç©ºãƒ»ç§‹é¢¨'},{char:'å†¬',read:'ãµã‚†',ex:'å†¬ç©ºãƒ»å†¬ä¼‘ã¿'},{char:'é›¨',read:'ã‚ã‚',ex:'é›¨ãƒ»å¤§é›¨'},{char:'é›ª',read:'ã‚†ã',ex:'é›ªãƒ»é›ªå±±'},{char:'é¢¨',read:'ã‹ãœ',ex:'é¢¨ãƒ»åŒ—é¢¨'},{char:'æ™´',read:'ã¯ã‚Œ',ex:'æ™´ã‚Œãƒ»å¿«æ™´'}],
  kanji2b:[{char:'æ±',read:'ã²ãŒã—',ex:'æ±ãƒ»æ±é¢¨'},{char:'è¥¿',read:'ã«ã—',ex:'è¥¿ãƒ»è¥¿æ—¥'},{char:'å—',read:'ã¿ãªã¿',ex:'å—ãƒ»å—é¢¨'},{char:'åŒ—',read:'ããŸ',ex:'åŒ—ãƒ»åŒ—é¢¨'},{char:'å³',read:'ã¿ã',ex:'å³ãƒ»å³æ‰‹'},{char:'å·¦',read:'ã²ã ã‚Š',ex:'å·¦ãƒ»å·¦æ‰‹'},{char:'å‰',read:'ã¾ãˆ',ex:'å‰ãƒ»å‰å¾Œ'},{char:'å¾Œ',read:'ã†ã—ã‚',ex:'å¾Œãƒ»å¾Œæ—¥'}],
  kanji2c:[{char:'è¦ª',read:'ãŠã‚„',ex:'ä¸¡è¦ªãƒ»è¦ªå­'},{char:'å‹',read:'ã¨ã‚‚',ex:'å‹äººãƒ»å‹é”'},{char:'å…„',read:'ã‚ã«',ex:'å…„ãƒ»å…„å¼Ÿ'},{char:'å¼Ÿ',read:'ãŠã¨ã†ã¨',ex:'å¼Ÿãƒ»å…„å¼Ÿ'},{char:'å§‰',read:'ã‚ã­',ex:'å§‰ãƒ»å§‰å¦¹'},{char:'å¦¹',read:'ã„ã‚‚ã†ã¨',ex:'å¦¹ãƒ»å§‰å¦¹'}],
  kanji3a:[{char:'æ—',read:'ãã',ex:'å®¶æ—ãƒ»ä¸€æ—'},{char:'åŒ»',read:'ã„',ex:'åŒ»è€…ãƒ»åŒ»é™¢'},{char:'æ—…',read:'ãŸã³',ex:'æ—…è¡Œãƒ»æ—…äºº'},{char:'éƒ¨',read:'ã¶',ex:'éƒ¨æ´»ãƒ»éƒ¨åˆ†'},{char:'å‘³',read:'ã‚ã˜',ex:'å‘³ãƒ»å‘³æ–¹'}],
  kanji3b:[{char:'è¾²',read:'ã®ã†',ex:'è¾²æ¥­ãƒ»è¾²å®¶'},{char:'æ¥­',read:'ãã‚‡ã†',ex:'ç”£æ¥­ãƒ»å·¥æ¥­'},{char:'æ¤',read:'ã†ãˆã‚‹',ex:'æ¤ç‰©ãƒ»æ¤ãˆã‚‹'},{char:'æ—',read:'ã¯ã‚„ã—',ex:'æ—ãƒ»å±±æ—'},{char:'æ£®',read:'ã‚‚ã‚Š',ex:'æ£®ãƒ»æ£®æ—'}],
};
function getQC(){if(dstate.age==='sho3')return 15;if(dstate.age==='sho2')return 12;if(dstate.age==='sho1')return 10;return 4;}
function getKFS(n){if(n>=15)return'12pt';if(n>=12)return'13pt';if(n>=10)return'14pt';return'16pt';}
function getKCols(n){return n>=12?3:2;}
let kokugoCtrs={};
function dColH(t){return `<div class="d-hdr"><span class="d-title">${t}</span><span class="d-brand">ãƒ‰ãƒªã‚¸ã‚§ãƒ</span></div><div class="d-meta"><span class="d-circle"></span><span>ãŒã¤</span><span class="d-circle"></span><span>ã«ã¡</span><span style="margin-left:3px;">ãªã¾ãˆ</span><div class="d-name"></div></div>`;}
function dGrid(){let h='<div class="d-grids">';for(let i=0;i<2;i++) h+=`<div class="d-grid-block"><div class="d-gnum">1</div><div class="d-gcells"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div><div class="d-gnum" style="margin-top:1mm;">2</div><div class="d-gcells"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`;return h+'</div>';}
function makeUnpitsu(type){
  const titles={yoko:'ã¾ã£ã™ã ã†ã‚“ã´ã¤ï¼ˆã‚ˆã“ï¼‰',tate:'ã¾ã£ã™ã ã†ã‚“ã´ã¤ï¼ˆãŸã¦ï¼‰',nami:'ãªã¿ãªã¿ ã†ã‚“ã´ã¤',zag:'ã–ã–ã– ã†ã‚“ã´ã¤'};
  const instrs={yoko:'ã²ã ã‚Šã‹ã‚‰ ã¿ãã¸ ã›ã‚“ã‚’ ã²ãã¾ã—ã‚‡ã†ã€‚',tate:'ã†ãˆã‹ã‚‰ ã—ãŸã¸ ã›ã‚“ã‚’ ã²ãã¾ã—ã‚‡ã†ã€‚',nami:'ãªã¿ãªã¿ã¨ ã›ã‚“ã‚’ ã‹ãã¾ã—ã‚‡ã†ã€‚',zag:'ã–ã–ã–ã¨ ã›ã‚“ã‚’ ã‹ãã¾ã—ã‚‡ã†ã€‚'};
  const rows={yoko:[[OM.ship,OM.ship],[OM.truck,OM.truck],[OM.bus,OM.bus]],tate:[[OM.frog,OM.frog],[OM.fish,OM.fish],[OM.rooster,OM.rooster],[OM.chick,OM.chick]],nami:[[OM.tropical_fish,OM.tropical_fish],[OM.dolphin,OM.dolphin],[OM.octopus,OM.octopus]],zag:[[OM.mountain,OM.mountain],[OM.lightning,OM.lightning],[OM.star,OM.star]]};
  let h=dColH(titles[type])+`<div class="d-instr"><span style="color:#C368F9;">â—</span>${instrs[type]}</div>`;
  if(type==='yoko'){h+='<div class="d-zz-frame">';rows.yoko.forEach(([l,r])=>h+=`<div class="d-zz-row">${omImg(l,'om')}<div class="d-zz-guide"></div>${omImg(r,'om')}</div>`);h+='</div>';}
  else if(type==='tate'){h+='<div class="d-vert-frame">';rows.tate.forEach(([t,b])=>h+=`<div class="d-vert-col">${omImg(t,'om-sm')}<div class="d-vert-guide"></div>${omImg(b,'om-sm')}</div>`);h+='</div>';}
  else if(type==='nami'){h+='<div class="d-wave-frame">';rows.nami.forEach(([l,r])=>h+=`<div class="d-wave-row">${omImg(l,'om')}<svg class="d-wave-svg" viewBox="0 0 300 50" preserveAspectRatio="none"><path d="M0,25 Q37,5 75,25 Q112,45 150,25 Q187,5 225,25 Q262,45 300,25" fill="none" stroke="#a098e8" stroke-width="3" stroke-dasharray="10,6"/></svg>${omImg(r,'om')}</div>`);h+='</div>';}
  else{h+='<div class="d-zg-frame">';rows.zag.forEach(([l,r])=>h+=`<div class="d-zg-row">${omImg(l,'om')}<svg style="position:absolute;left:58px;right:58px;top:0;bottom:0;width:calc(100% - 116px);height:100%;" viewBox="0 0 300 50" preserveAspectRatio="none"><polyline points="0,38 60,10 120,38 180,10 240,38 300,10" fill="none" stroke="#a098e8" stroke-width="3" stroke-dasharray="10,6" stroke-linejoin="round"/></svg>${omImg(r,'om')}</div>`);h+='</div>';}
  return h;
}
function makeHiragana(theme){
  if(!kokugoCtrs[theme]) kokugoCtrs[theme]=0;
  const words=kokugoThemes[theme]||kokugoThemes.dobutsu;
  const w=[0,1,2,3].map(i=>words[(kokugoCtrs[theme]+i)%words.length]);
  kokugoCtrs[theme]+=4;
  let h=dColH('ã²ã‚‰ãŒãª ã“ã¨ã°ã‚«ãƒ¼ãƒ‰')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã“ã¨ã°ã‚’ ã‚ˆã¿ã¾ã—ã‚‡ã†ã€‚</div><div class="d-cards-col">`;
  h+=`<div class="d-card-pair"><div class="d-kana-card" style="background:${w[0].bg};"><div class="d-bubble">${w[0].word}</div>${omImg(w[0].hex,'d-card-om')}</div><div class="d-kana-card" style="background:${w[1].bg};"><div class="d-bubble">${w[1].word}</div>${omImg(w[1].hex,'d-card-om')}</div></div>`;
  h+=`<div class="d-card-pair"><div class="d-kana-card" style="background:${w[2].bg};"><div class="d-bubble">${w[2].word}</div>${omImg(w[2].hex,'d-card-om')}</div><div class="d-kana-card" style="background:${w[3].bg};"><div class="d-bubble">${w[3].word}</div>${omImg(w[3].hex,'d-card-om')}</div></div>`;
  return h+'</div>'+dGrid();
}
function makeKanji(type){
  const data=kanjiData[type]||kanjiData.kanji1a;
  const cnt=getQC(),show=Math.min(data.length,cnt>=10?8:6);
  let h=dColH('æ¼¢å­— ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‹ã‚“ã˜ã‚’ ã‚ˆã‚“ã§ã€ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-kanji-frame">`;
  data.slice(0,show).forEach(k=>h+=`<div class="d-kanji-row"><div class="d-kanji-char">${k.char}</div><div class="d-kanji-info"><b>ã‚ˆã¿ï¼š</b>${k.read}ã€€<b>ã‚Œã„ï¼š</b>${k.ex}</div><div class="d-kanji-write"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);
  return h+'</div>';
}
function makeKazu(type){
  let h=dColH('ã‹ãšã® ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‹ãšã‚’ ã‹ããˆã¦ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-kazu-frame">`;
  if(type==='tasu_k'){[[1,1],[1,2],[2,1]].forEach(([a,b])=>h+=`<div class="d-kazu-row" style="font-size:20pt;font-weight:900;gap:10px;"><span>${a}</span><span style="color:#C368F9;">ï¼‹</span><span>${b}</span><span style="color:#C368F9;">ï¼</span><div class="d-kazu-write"><div class="d-cell d-slash"></div><div class="d-cell"></div></div></div>`);}
  else{[1,2,3].forEach(n=>h+=`<div class="d-kazu-row"><div class="d-kazu-num">${n}</div><div class="d-kazu-dots">${Array(n).fill('<span class="d-dot"></span>').join('')}</div><div class="d-kazu-write"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);}
  return h+'</div>';
}
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function makeKeisan(type){
  const cnt=getQC(),cols=getKCols(cnt),fs=getKFS(cnt);
  const titles={tasu1:'ãŸã—ç®—',tasu2:'ãŸã—ç®—ï¼ˆãã‚Šä¸ŠãŒã‚Šï¼‰',hiki1:'ã²ãç®—',hiki2:'ã²ãç®—ï¼ˆãã‚Šä¸‹ãŒã‚Šï¼‰',tasu2a:'ãŸã—ç®—ï¼ˆ2æ¡ï¼‰',tasu2b:'ãŸã—ç®—ï¼ˆ2æ¡ï¼‰',hiki2a:'ã²ãç®—ï¼ˆ2æ¡ï¼‰',hiki2b:'ã²ãç®—ï¼ˆ2æ¡ï¼‰',kake2:'ã‹ã‘ç®—',kake3:'ã‹ã‘ç®—ï¼ˆ3æ¡ï¼‰',wari1:'ã‚ã‚Šç®—'};
  let h=dColH((titles[type]||'ã‘ã„ã•ã‚“')+' ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‘ã„ã•ã‚“ã—ã¾ã—ã‚‡ã†ã€‚</div><div class="d-keisan-frame"><div class="d-keisan-grid" style="grid-template-columns:repeat(${cols},1fr);">`;
  for(let i=0;i<cnt;i++){
    let a,b,op='ï¼‹';
    if(type==='tasu1'){a=ri(1,8);b=ri(1,9-a);}else if(type==='tasu2'){a=ri(2,9);b=ri(Math.max(1,10-a),9);}else if(type==='hiki1'){a=ri(2,9);b=ri(1,a-1);op='ï¼';}else if(type==='hiki2'){a=ri(11,18);b=ri(a-9,a-2);op='ï¼';}else if(type==='tasu2a'){a=ri(11,89);b=ri(1,9);}else if(type==='tasu2b'){a=ri(11,79);b=ri(11,Math.min(89,99-a));}else if(type==='hiki2a'){a=ri(11,99);b=ri(1,Math.min(9,a-1));op='ï¼';}else if(type==='hiki2b'){a=ri(20,99);b=ri(11,a-9);op='ï¼';}else if(type==='kake2'){a=ri(11,99);b=ri(2,9);op='Ã—';}else if(type==='kake3'){a=ri(100,999);b=ri(2,9);op='Ã—';}else if(type==='wari1'){b=ri(2,9);const ans=ri(2,9);a=b*ans;op='Ã·';}else{a=ri(1,9);b=ri(1,9);}
    h+=`<div class="d-keisan-item" style="font-size:${fs};"><span class="d-qnum">${i+1}</span><span>${a}</span><span style="color:#876AFF;">${op}</span><span>${b}</span><span style="color:#876AFF;">ï¼</span><span class="d-ans-box"></span></div>`;
  }
  return h+'</div></div>';
}
function makeKuku(type){
  const cnt=getQC(),cols=getKCols(cnt),fs=getKFS(cnt);
  const ranges={kuku2:[2,3,4],kuku5:[5,6,7],kuku8:[8,9]};
  const danList=ranges[type]||[2,3,4];
  let h=dColH('ä¹ä¹ ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ããã‚’ ã‚Œã‚“ã—ã‚…ã†ã—ã¾ã—ã‚‡ã†ã€‚</div><div class="d-keisan-frame"><div class="d-keisan-grid" style="grid-template-columns:repeat(${cols},1fr);">`;
  for(let i=0;i<cnt;i++){const d=danList[i%danList.length],n=ri(1,9);h+=`<div class="d-keisan-item" style="font-size:${fs};"><span class="d-qnum">${i+1}</span><span>${d}</span><span style="color:#876AFF;">Ã—</span><span>${n}</span><span style="color:#876AFF;">ï¼</span><span class="d-ans-box"></span></div>`;}
  return h+'</div></div>';
}
function makeTokei(type){
  const sets={tokei_h:[{h:1,m:0},{h:3,m:0},{h:6,m:0},{h:9,m:0},{h:12,m:0},{h:10,m:0}],tokei_hh:[{h:1,m:30},{h:4,m:30},{h:7,m:30},{h:10,m:30},{h:2,m:30},{h:8,m:30}],tokei_min:[{h:2,m:15},{h:5,m:45},{h:8,m:20},{h:11,m:50},{h:3,m:35},{h:6,m:10}],tokei_all:[{h:9,m:0},{h:9,m:30},{h:10,m:0},{h:10,m:30},{h:8,m:15},{h:11,m:45}]};
  const times=sets[type]||sets.tokei_h;
  function svgC(hh,mm){const ha=((hh%12)+mm/60)/12*360-90,ma=mm/60*360-90,hx=26+14*Math.cos(ha*Math.PI/180),hy=26+14*Math.sin(ha*Math.PI/180),mx=26+20*Math.cos(ma*Math.PI/180),my=26+20*Math.sin(ma*Math.PI/180);let t='';for(let i=0;i<12;i++){const a=i/12*360-90;t+=`<line x1="${26+22*Math.cos(a*Math.PI/180)}" y1="${26+22*Math.sin(a*Math.PI/180)}" x2="${26+(i%3===0?17:20)*Math.cos(a*Math.PI/180)}" y2="${26+(i%3===0?17:20)*Math.sin(a*Math.PI/180)}" stroke="#555" stroke-width="${i%3===0?2:1}"/>`;}return `<svg class="d-clock-svg" viewBox="0 0 52 52"><circle cx="26" cy="26" r="24" fill="white" stroke="#aaa" stroke-width="1.5"/>${t}<line x1="26" y1="26" x2="${hx}" y2="${hy}" stroke="#333" stroke-width="2.5" stroke-linecap="round"/><line x1="26" y1="26" x2="${mx}" y2="${my}" stroke="#555" stroke-width="1.5" stroke-linecap="round"/><circle cx="26" cy="26" r="2" fill="#333"/></svg>`;}
  let h=dColH('ã¨ã‘ã„ã‚’ ã‚ˆã‚‚ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã¨ã‘ã„ã‚’ã‚ˆã‚“ã§ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-tokei-frame">`;
  times.forEach(t=>h+=`<div class="d-clock-cell">${svgC(t.h,t.m)}<div class="d-clock-write"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);
  return h+'</div>';
}
function makeColContent(detail){
  const up=['yoko','tate','nami','zag'],hi=['dobutsu','tabemono','norimono','shizen'],kj=['kanji1a','kanji1b','kanji1c','kanji2a','kanji2b','kanji2c','kanji3a','kanji3b'],kz=['k1_5','k1_10','tasu_k'],ks=['tasu1','tasu2','hiki1','hiki2','tasu2a','tasu2b','hiki2a','hiki2b','kake2','kake3','wari1','masu_tasu','masu_hiki'],kk=['kuku2','kuku5','kuku8'],tk=['tokei_h','tokei_hh','tokei_min','tokei_all'];
  if(up.includes(detail)) return makeUnpitsu(detail);
  if(hi.includes(detail)) return makeHiragana(detail);
  if(kj.includes(detail)) return makeKanji(detail);
  if(kz.includes(detail)) return makeKazu(detail);
  if(kk.includes(detail)) return makeKuku(detail);
  if(tk.includes(detail)) return makeTokei(detail);
  if(ks.includes(detail)) return makeKeisan(detail);
  return dColH('â€”');
}

function generateAndPrint(){
  const pages=parseInt(dstate.pages);
  kokugoCtrs={};
  const slots=[...dstate.detail];
  while(slots.length<pages*2) slots.push(...slots.slice(0,Math.min(slots.length,pages*2-slots.length)));
  let html='';
  for(let i=0;i<pages;i++){
    const l=slots[(i*2)%slots.length],r=slots[(i*2+1)%slots.length];
    html+=`<div class="drill-page"><div class="drill-pid">p.${i+1}</div><div class="drill-two-col"><div class="drill-col">${makeColContent(l)}</div><div class="drill-divider"></div><div class="drill-col">${makeColContent(r)}</div></div></div>`;
  }
  const pt=document.getElementById('print-target');
  pt.innerHTML=html;
  pt.style.cssText='display:block;position:fixed;top:0;left:0;z-index:9999;background:#ede8ff;overflow-y:auto;width:100%;height:100%;';
  const close=document.createElement('button');
  close.textContent='âœ• ã¨ã˜ã‚‹';
  close.style.cssText='position:fixed;top:12px;right:12px;z-index:10000;background:linear-gradient(135deg,#C368F9,#876AFF);color:white;border:none;padding:10px 18px;border-radius:20px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(135,106,255,.3);font-family:inherit;';
  close.onclick=()=>{pt.style.display='none';pt.innerHTML='';};
  pt.prepend(close);
  const printBtn=document.createElement('button');
  printBtn.textContent='ğŸ–¨ï¸ å°åˆ·ã™ã‚‹';
  printBtn.style.cssText='position:fixed;top:12px;right:120px;z-index:10000;background:linear-gradient(135deg,#38b896,#60E2B7);color:white;border:none;padding:10px 18px;border-radius:20px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(96,226,183,.3);font-family:inherit;';
  printBtn.onclick=()=>window.print();
  pt.prepend(printBtn);
  // ã‹ã‚“ã‚Šã‚‡ã†ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  document.getElementById('kanryo-card').style.display='block';
  renderDrillTypes();
  window.scrollTo({top:9999,behavior:'smooth'});
}

// ===== INIT =====
renderCreature(false);
updateIkuseiUI();
renderDrillTypes();
renderBadges();
</script>
</body>
</html>
