<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‰ãƒªã‚¸ã‚§ãƒ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
:root{
  --p:#C368F9;--i:#876AFF;--e:#60E2B7;--ed:#38b896;
  --pm:#e8c0fd;--pl:#faf5ff;
  --tx:#1a1030;--txs:#6b5b8a;--bd:#ede0ff;
  --card:#ffffff;--bg:#f7f3ff;
  --r:20px;
  --shadow:0 8px 32px rgba(135,106,255,.12);
  --shadow-sm:0 2px 12px rgba(135,106,255,.08);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Nunito','Hiragino Maru Gothic Pro',sans-serif;background:var(--bg);color:var(--tx);min-height:100dvh;}

/* ===== HEADER ===== */
header{
  background:var(--card);
  padding:14px 20px 12px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
  border-bottom:1px solid var(--bd);
  box-shadow:var(--shadow-sm);
}
.logo{display:flex;align-items:center;gap:8px;}
.logo-icon{
  width:36px;height:36px;border-radius:12px;
  background:linear-gradient(135deg,var(--p),var(--i));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 4px 12px rgba(195,104,249,.3);
}
.logo-text{font-size:18px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--i));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.02em;}

/* ===== NAV ===== */
.gnav{
  display:flex;background:var(--card);
  border-bottom:1px solid var(--bd);
  position:sticky;top:62px;z-index:90;
  padding:0 8px;
}
.gnav button{
  flex:1;padding:12px 4px 10px;border:none;background:none;
  font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;
  color:var(--txs);border-bottom:3px solid transparent;transition:all .2s;
  display:flex;flex-direction:column;align-items:center;gap:2px;
}
.gnav button .nicon{font-size:17px;}
.gnav button.act{color:var(--p);border-bottom-color:var(--p);}

main{max-width:480px;margin:0 auto;padding:20px 16px 90px;}

/* ===== STEP UI ===== */
.progress-wrap{margin-bottom:24px;}
.step-counter{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.step-counter-label{font-size:12px;font-weight:700;color:var(--txs);}
.step-counter-dots{display:flex;gap:5px;}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--bd);transition:all .3s;}
.sdot.done{background:var(--i);}
.sdot.active{background:var(--p);width:20px;border-radius:99px;box-shadow:0 0 0 3px rgba(195,104,249,.2);}
.prog-bar-bg{background:var(--bd);border-radius:99px;height:4px;overflow:hidden;}
.prog-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--p),var(--i));transition:width .5s ease;}

.step{display:none;animation:fadeUp .3s ease;}
.step.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.step-eyebrow{font-size:11px;font-weight:700;color:var(--p);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
.step-title{font-size:24px;font-weight:900;line-height:1.2;color:var(--tx);margin-bottom:4px;letter-spacing:-.02em;}
.step-sub{font-size:13px;color:var(--txs);margin-bottom:20px;line-height:1.5;}

/* ===== CHOICE CARDS ===== */
.card-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.card-grid.three{grid-template-columns:repeat(3,1fr);}
.choice-card{
  background:var(--card);border:2px solid var(--bd);border-radius:var(--r);
  padding:16px 12px;text-align:center;cursor:pointer;
  transition:all .18s cubic-bezier(.4,2,.6,1);
  user-select:none;position:relative;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:88px;box-shadow:var(--shadow-sm);
}
.choice-card:active{transform:scale(.96);}
.choice-card.selected{
  border-color:var(--p);background:var(--pl);
  box-shadow:0 4px 20px rgba(195,104,249,.2);
  transform:translateY(-2px);
}
.choice-card .cicon{font-size:26px;margin-bottom:6px;}
.choice-card .clabel{font-size:12px;font-weight:900;color:var(--tx);line-height:1.3;}
.choice-card .cdesc{font-size:10px;color:var(--txs);margin-top:3px;}
.ck{position:absolute;top:8px;right:8px;width:18px;height:18px;border-radius:50%;background:var(--bd);border:none;transition:all .18s;}
.choice-card.selected .ck{background:var(--p);box-shadow:0 0 0 2px rgba(195,104,249,.3);}
.choice-card.selected .ck::after{content:'âœ“';color:white;font-size:9px;font-weight:900;display:flex;align-items:center;justify-content:center;line-height:18px;}
.sec-label{grid-column:1/-1;font-size:11px;font-weight:900;color:var(--p);padding:10px 2px 4px;text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--bd);}

/* ===== BUTTONS ===== */
.btn-row{display:flex;gap:10px;margin-top:20px;}
.btn{flex:1;padding:15px;border-radius:99px;border:none;font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;transition:all .18s;min-height:50px;letter-spacing:-.01em;}
.btn-back{background:var(--bd);color:var(--txs);flex:0 0 auto;padding:15px 20px;}
.btn-back:active{background:#ddd8f8;}
.btn-next{background:linear-gradient(135deg,var(--p),var(--i));color:white;box-shadow:0 6px 20px rgba(195,104,249,.4);}
.btn-next:active{transform:scale(.98);}
.btn-next:disabled{background:#e0e0e0;color:#aaa;box-shadow:none;}
.btn-print{background:linear-gradient(135deg,var(--ed),var(--e));color:white;box-shadow:0 6px 20px rgba(96,226,183,.35);font-size:15px;}
.btn-reset{display:block;margin:10px auto 0;background:none;border:none;color:var(--txs);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;padding:8px 16px;}

/* ===== SUMMARY ===== */
.summary-card{
  background:var(--card);border-radius:var(--r);
  border:2px solid var(--bd);padding:18px;margin-top:18px;
  box-shadow:var(--shadow-sm);
}
.summary-card h3{font-size:11px;font-weight:900;color:var(--txs);text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;}
.srow{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--bg);}
.srow:last-child{border-bottom:none;}
.slabel{font-size:11px;color:var(--txs);min-width:68px;padding-top:1px;font-weight:700;}
.sval{font-size:13px;font-weight:900;flex:1;color:var(--tx);line-height:1.4;}
.notice{
  background:linear-gradient(135deg,#fffdf0,#fff8e0);
  border:1.5px solid #f0d860;border-radius:14px;
  padding:12px 14px;margin-top:14px;font-size:11px;color:#7a6a00;line-height:1.6;
}

/* ===== KANRYO CARD ===== */
.kanryo-card{
  background:linear-gradient(135deg,var(--pl),#f0edff);
  border:2px solid var(--pm);border-radius:var(--r);
  padding:20px 16px;margin-top:16px;text-align:center;
  box-shadow:var(--shadow);
}
.kanryo-emoji{font-size:40px;margin-bottom:8px;}
.kanryo-title{font-size:17px;font-weight:900;color:var(--p);margin-bottom:4px;letter-spacing:-.02em;}
.kanryo-sub{font-size:12px;color:var(--txs);margin-bottom:14px;line-height:1.5;}
.dtype-wrap{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:14px;}
.dtype-btn{
  padding:5px 11px;border-radius:99px;border:1.5px solid var(--bd);
  font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;
  background:var(--card);color:var(--txs);transition:all .15s;
}
.dtype-btn.sel{border-color:var(--p);background:var(--pl);color:var(--p);}
.btn-kanryo{
  width:100%;padding:15px;border-radius:99px;border:none;
  background:linear-gradient(135deg,var(--ed),var(--e));
  color:white;font-size:15px;font-weight:900;cursor:pointer;
  font-family:inherit;box-shadow:0 6px 20px rgba(96,226,183,.35);
  letter-spacing:-.01em;
}
.btn-kanryo:active{transform:scale(.98);}

/* ===== IKUSEI ===== */
.creature-card{
  background:var(--card);border-radius:var(--r);
  padding:20px 16px;margin-bottom:14px;
  box-shadow:var(--shadow);border:2px solid var(--bd);
  position:relative;overflow:hidden;
}
.creature-card::before{
  content:'';position:absolute;top:-40px;right:-40px;
  width:160px;height:160px;border-radius:50%;
  background:radial-gradient(circle,rgba(195,104,249,.08),transparent 70%);
  pointer-events:none;
}
.stage-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.stage-pill{
  background:linear-gradient(135deg,var(--p),var(--i));color:white;
  font-size:10px;font-weight:900;padding:4px 12px;border-radius:99px;
  box-shadow:0 4px 12px rgba(195,104,249,.3);letter-spacing:.04em;
}
.streak-pill{font-size:12px;font-weight:700;color:var(--txs);}
.creature-center{text-align:center;position:relative;margin-bottom:12px;}
.creature-name{font-size:20px;font-weight:900;color:var(--tx);letter-spacing:-.02em;margin-bottom:2px;}
.creature-name-sub{font-size:12px;color:var(--txs);margin-bottom:10px;}
.name-edit-btn{
  background:var(--bd);border:none;border-radius:99px;
  padding:4px 10px;font-size:10px;font-weight:700;color:var(--txs);
  cursor:pointer;font-family:inherit;margin-left:6px;transition:all .15s;
}
.name-edit-btn:hover{background:var(--pm);color:var(--p);}
.name-input-wrap{margin:8px auto;max-width:200px;position:relative;}
.name-input{
  width:100%;padding:8px 14px;border-radius:99px;
  border:2px solid var(--p);font-family:inherit;font-size:14px;
  font-weight:700;text-align:center;color:var(--tx);
  background:var(--pl);outline:none;
}
.name-save-btn{
  margin-top:6px;padding:7px 20px;border-radius:99px;border:none;
  background:linear-gradient(135deg,var(--p),var(--i));color:white;
  font-size:12px;font-weight:900;cursor:pointer;font-family:inherit;
}
.xp-section{margin-bottom:10px;}
.xp-meta{display:flex;justify-content:space-between;font-size:10px;font-weight:700;color:var(--txs);margin-bottom:5px;}
.xp-bg{background:var(--bd);border-radius:99px;height:10px;overflow:hidden;}
.xp-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--p),var(--i));transition:width .8s cubic-bezier(.4,2,.6,1);box-shadow:0 0 8px rgba(195,104,249,.4);}
.stat-row{display:flex;gap:8px;margin-top:12px;}
.stat-box{flex:1;background:var(--bg);border-radius:14px;padding:10px 6px;text-align:center;border:1.5px solid var(--bd);}
.stat-box .sbi{font-size:18px;}
.stat-box .sbl{font-size:9px;color:var(--txs);font-weight:700;margin-top:1px;text-transform:uppercase;letter-spacing:.04em;}
.stat-box .sbv{font-size:13px;font-weight:900;color:var(--i);margin-top:1px;}

/* ===== REPORT ===== */
.report-section{background:var(--card);border-radius:var(--r);padding:18px;margin-bottom:12px;border:2px solid var(--bd);box-shadow:var(--shadow-sm);}
.report-section h3{font-size:13px;font-weight:900;color:var(--tx);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
.report-section h3 span{font-size:16px;}
.chart-wrap{display:flex;align-items:flex-end;gap:6px;height:80px;padding-bottom:4px;}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
.chart-bar{width:100%;border-radius:6px 6px 0 0;background:linear-gradient(180deg,var(--p),var(--i));transition:height .6s ease;min-height:4px;}
.chart-label{font-size:9px;color:var(--txs);font-weight:700;text-align:center;}
.report-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.report-item{background:var(--bg);border-radius:14px;padding:12px 10px;text-align:center;border:1.5px solid var(--bd);}
.report-item .ri-val{font-size:22px;font-weight:900;color:var(--p);letter-spacing:-.02em;}
.report-item .ri-unit{font-size:10px;color:var(--txs);margin-left:2px;}
.report-item .ri-label{font-size:10px;color:var(--txs);font-weight:700;margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}
.subject-bar-wrap{display:flex;flex-direction:column;gap:8px;}
.subject-bar-row{display:flex;align-items:center;gap:8px;}
.subject-bar-label{font-size:11px;font-weight:700;color:var(--tx);min-width:52px;}
.subject-bar-bg{flex:1;background:var(--bd);border-radius:99px;height:8px;overflow:hidden;}
.subject-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--p),var(--i));transition:width .8s ease;}
.subject-bar-val{font-size:11px;font-weight:900;color:var(--p);min-width:28px;text-align:right;}
.streak-calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:4px;}
.scal-cell{aspect-ratio:1;border-radius:5px;background:var(--bd);}
.scal-cell.done{background:linear-gradient(135deg,var(--p),var(--i));}
.scal-cell.today{box-shadow:0 0 0 2px var(--p);}

/* ===== LOG ===== */
.log-item{
  background:var(--card);border-radius:16px;padding:12px 14px;
  margin-bottom:8px;border:1.5px solid var(--bd);
  display:flex;align-items:center;gap:12px;box-shadow:var(--shadow-sm);
}
.log-icon{
  width:38px;height:38px;border-radius:12px;
  background:linear-gradient(135deg,rgba(195,104,249,.12),rgba(135,106,255,.12));
  display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
}
.xp-chip{background:linear-gradient(135deg,var(--pl),#ede0ff);color:var(--p);border-radius:99px;padding:3px 10px;font-size:11px;font-weight:900;border:1.5px solid var(--pm);}

/* ===== BADGES ===== */
.badge-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.badge-item{
  background:var(--card);border-radius:var(--r);padding:16px 12px;
  text-align:center;border:2px solid;
  box-shadow:var(--shadow-sm);transition:all .2s;
}
.badge-item.earned{border-color:var(--pm);}
.badge-item.locked{border-color:var(--bd);opacity:.45;}
.badge-item .bicon{font-size:36px;margin-bottom:6px;}
.badge-item .bname{font-size:11px;font-weight:900;margin-top:2px;}
.badge-item .bstatus{font-size:10px;margin-top:3px;}

/* ===== TOAST / LEVELUP ===== */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--card);border:2px solid var(--pm);
  border-radius:99px;padding:10px 22px;
  box-shadow:0 8px 24px rgba(135,106,255,.2);z-index:500;
  white-space:nowrap;animation:toastIn .4s cubic-bezier(.4,2,.6,1);
  color:var(--p);font-weight:900;font-size:13px;
}
.levelup-pop{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  background:var(--card);border:3px solid var(--p);
  border-radius:20px;padding:16px 24px;text-align:center;
  box-shadow:0 12px 40px rgba(195,104,249,.4);z-index:10;
  animation:popIn .4s cubic-bezier(.4,2,.6,1);
}
@keyframes toastIn{0%{opacity:0;transform:translateX(-50%) translateY(16px)}100%{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes popIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
@keyframes particleFly{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
@keyframes fc{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
@keyframes cb{0%,100%{transform:translateY(0)}40%{transform:translateY(-20px)}70%{transform:translateY(-14px)}}
@keyframes eb{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.08)}}
@keyframes t1{0%,100%{transform:rotate(0)}50%{transform:rotate(13deg)}}
@keyframes t2{0%,100%{transform:rotate(0)}50%{transform:rotate(-13deg)}}
@keyframes sp{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}

/* ===== PRINT ===== */
@media print{
  @page{size:A4 landscape;margin:0;}
  body>*{display:none!important;}
  #print-target{display:block!important;}
}
#print-target{display:none;}
.drill-page{width:297mm;height:210mm;background:white;padding:5mm 7mm;display:flex;flex-direction:column;position:relative;overflow:hidden;page-break-after:always;}
.drill-two-col{display:flex;gap:5mm;flex:1;min-height:0;}
.drill-col{flex:1;display:flex;flex-direction:column;min-width:0;}
.drill-divider{width:1px;background:#e8e0f8;flex-shrink:0;}
.drill-pid{position:absolute;top:3mm;right:7mm;font-size:8pt;color:#ccc;}
.d-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5mm;}
.d-title{font-size:11.5pt;font-weight:bold;color:#2d2040;}
.d-brand{font-size:8pt;font-weight:bold;background:linear-gradient(135deg,#C368F9,#876AFF);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.d-meta{display:flex;align-items:center;gap:4px;margin-bottom:1.5mm;font-size:8pt;color:#888;}
.d-circle{width:20px;height:20px;border:1.5px solid #ccc;border-radius:50%;display:inline-block;flex-shrink:0;}
.d-name{border:1.5px solid #ccc;border-radius:3px;flex:1;height:19px;}
.d-instr{font-size:9.5pt;font-weight:bold;color:#2d2040;margin-bottom:1.5mm;display:flex;align-items:center;gap:4px;}
.d-zz-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;flex-direction:column;gap:2mm;min-height:0;}
.d-zz-row{display:flex;align-items:center;justify-content:space-between;border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;}
.d-zz-guide{position:absolute;left:58px;right:58px;top:50%;border-top:2.5px dashed #e0a8fc;transform:translateY(-50%);}
.d-vert-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;gap:2mm;}
.d-vert-col{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:space-between;border-radius:3px;background:white;padding:5px 3px;position:relative;}
.d-vert-guide{position:absolute;top:48px;bottom:48px;left:50%;border-left:2.5px dashed #e0a8fc;transform:translateX(-50%);}
.d-wave-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-wave-row{border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;display:flex;align-items:center;justify-content:space-between;overflow:hidden;}
.d-wave-svg{position:absolute;left:58px;right:58px;top:0;bottom:0;width:calc(100% - 116px);height:100%;}
.d-zg-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-zg-row{border-radius:3px;background:white;flex:1;padding:3px 8px;position:relative;display:flex;align-items:center;justify-content:space-between;overflow:hidden;}
.om{width:54px;height:54px;object-fit:contain;flex-shrink:0;}
.om-sm{width:40px;height:40px;object-fit:contain;flex-shrink:0;}
.d-cards-col{display:flex;flex-direction:column;gap:2.5mm;flex:1;min-height:0;}
.d-card-pair{display:flex;gap:2.5mm;flex:1;}
.d-kana-card{border-radius:9px;padding:3px 5px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.d-bubble{background:white;border-radius:12px;padding:2px 8px;font-size:14pt;font-weight:bold;color:#2d2040;margin-bottom:2px;display:inline-block;}
.d-card-om{width:60px;height:60px;object-fit:contain;}
.d-grids{display:flex;gap:4mm;justify-content:center;margin-top:2mm;flex-shrink:0;}
.d-grid-block{display:flex;flex-direction:column;gap:1mm;}
.d-gnum{font-size:7.5pt;color:#aaa;}
.d-gcells{display:flex;}
.d-cell{width:10mm;height:10mm;border:1.5px solid #ccc;position:relative;}
.d-cell::after{content:'';position:absolute;left:50%;top:0;bottom:0;border-left:1px dashed #eee;}
.d-cell::before{content:'';position:absolute;top:50%;left:0;right:0;border-top:1px dashed #eee;}
.d-slash{background:linear-gradient(to bottom right,transparent calc(50% - 1px),#ccc 50%,transparent calc(50% + 1px));}
.d-keisan-frame{border:3.5px solid #60E2B7;border-radius:5px;padding:2.5mm;background:#b0f4e0;flex:1;display:flex;flex-direction:column;}
.d-keisan-grid{display:grid;gap:1.5mm;flex:1;}
.d-keisan-item{background:white;border-radius:3px;display:flex;align-items:center;justify-content:center;gap:3px;font-weight:900;color:#2d2040;padding:2px 4px;}
.d-ans-box{border-bottom:2px solid #876AFF;min-width:22px;height:18px;display:inline-block;margin-left:2px;}
.d-qnum{font-size:7pt;color:#aaa;margin-right:1px;}
.d-kanji-frame{border:3.5px solid #C368F9;border-radius:5px;padding:2.5mm;background:#f3d4fe;flex:1;display:flex;flex-direction:column;gap:1.5mm;}
.d-kanji-row{border-radius:3px;background:white;flex:1;padding:3px 6px;display:flex;align-items:center;gap:6px;}
.d-kanji-char{font-size:20pt;font-weight:900;color:#2d2040;min-width:34px;text-align:center;border-right:2px solid #f0e8ff;padding-right:6px;}
.d-kanji-info{flex:1;font-size:8pt;color:#555;line-height:1.5;}
.d-kanji-write{display:flex;}
.d-tokei-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:row;flex-wrap:wrap;gap:2mm;align-content:flex-start;}
.d-clock-cell{background:white;border-radius:5px;padding:3px;flex:0 0 calc(33.3% - 1.5mm);display:flex;flex-direction:column;align-items:center;}
.d-clock-svg{width:46px;height:46px;}
.d-clock-write{display:flex;margin-top:2px;}
.d-kazu-frame{border:3.5px solid #60E2B7;border-radius:5px;padding:2.5mm;background:#b0f4e0;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-kazu-row{border-radius:3px;background:white;flex:1;padding:4px 8px;display:flex;align-items:center;gap:6px;}
.d-kazu-num{font-size:22pt;font-weight:900;color:#2d2040;min-width:32px;text-align:center;}
.d-dot{width:13px;height:13px;border-radius:50%;background:#C368F9;display:inline-block;}
.d-kazu-write{display:flex;margin-left:auto;}
.d-ikutsu-frame{border:3.5px solid #f5a0bc;border-radius:5px;padding:2.5mm;background:#ffc8dd;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-ikutsu-row{border-radius:3px;background:white;flex:1;padding:4px 8px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:16pt;font-weight:900;}
.d-ikutsu-box{border-bottom:2.5px solid #C368F9;min-width:28px;height:22px;display:inline-block;}
.d-daisho-frame{border:3.5px solid #876AFF;border-radius:5px;padding:2.5mm;background:#d8d0ff;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-daisho-row{border-radius:3px;background:white;flex:1;padding:4px 10px;display:flex;align-items:center;justify-content:center;gap:10px;font-size:22pt;font-weight:900;}
.d-daisho-box{border:2px solid #876AFF;border-radius:6px;min-width:32px;height:34px;display:inline-flex;align-items:center;justify-content:center;font-size:10pt;color:#aaa;}
.d-junjo-frame{border:3.5px solid #60E2B7;border-radius:5px;padding:2.5mm;background:#b0f4e0;flex:1;display:flex;flex-direction:column;gap:2mm;}
.d-junjo-row{border-radius:3px;background:white;flex:1;padding:4px 8px;display:flex;align-items:center;gap:4px;overflow:hidden;}
.d-junjo-item{width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.d-junjo-item.q{background:#e8e0ff;border:2px solid #876AFF;}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">âœï¸</div>
    <span class="logo-text">ãƒ‰ãƒªã‚¸ã‚§ãƒ</span>
  </div>
  <div style="font-size:11px;font-weight:700;color:var(--txs);">å­¦ç¿’ãƒ—ãƒªãƒ³ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</div>
</header>

<div class="gnav">
  <button id="nav-drill" class="act" onclick="switchTab('drill')"><span class="nicon">ğŸ“„</span>ãƒ‰ãƒªãƒ«</button>
  <button id="nav-ikusei" onclick="switchTab('ikusei')"><span class="nicon">ğŸ¥š</span>ãã ã¦ã‚‹</button>
  <button id="nav-report" onclick="switchTab('report')"><span class="nicon">ğŸ“Š</span>ãƒ¬ãƒãƒ¼ãƒˆ</button>
  <button id="nav-log" onclick="switchTab('log')"><span class="nicon">ğŸ“‹</span>ãã‚ã</button>
  <button id="nav-badges" onclick="switchTab('badges')"><span class="nicon">ğŸ…</span>ãƒãƒƒã‚¸</button>
</div>

<main>
  <!-- DRILL TAB -->
  <div id="tab-drill">
    <div style="height:14px"></div>
    <div class="progress-wrap">
      <div class="step-counter">
        <span class="step-counter-label" id="prog-label">STEP 1 / 4</span>
        <div class="step-counter-dots">
          <div class="sdot active" id="p0"></div>
          <div class="sdot" id="p1"></div>
          <div class="sdot" id="p2"></div>
          <div class="sdot" id="p3"></div>
        </div>
      </div>
      <div class="prog-bar-bg"><div class="prog-bar-fill" id="prog-fill" style="width:25%"></div></div>
    </div>

    <div class="step active" id="step0">
      <div class="step-eyebrow">Step 1</div>
      <div class="step-title">ã ã‚Œã®ãƒ‰ãƒªãƒ«ã‚’<br>ä½œã‚‹ï¼Ÿ</div>
      <div class="step-sub">å¹´é½¢ã¾ãŸã¯å­¦å¹´ã‚’é¸ã‚“ã§ã­</div>
      <div class="card-grid">
        <div class="choice-card" data-val="yoji2" onclick="selectOne(this,'age')"><div class="cicon">ğŸ£</div><div class="clabel">2ã€œ3æ­³</div><div class="cdesc">é‹ç­†ãƒ»ã‹ãšå…¥é–€</div><div class="ck"></div></div>
        <div class="choice-card" data-val="yoji4" onclick="selectOne(this,'age')"><div class="cicon">ğŸ¥</div><div class="clabel">4ã€œ5æ­³</div><div class="cdesc">ã²ã‚‰ãŒãªãƒ»ã‹ãš</div><div class="ck"></div></div>
        <div class="choice-card" data-val="yoji6" onclick="selectOne(this,'age')"><div class="cicon">ğŸŒŸ</div><div class="clabel">å¹´é•·ï¼ˆ5ã€œ6æ­³ï¼‰</div><div class="cdesc">å…¥å­¦æº–å‚™</div><div class="ck"></div></div>
        <div class="choice-card" data-val="sho1" onclick="selectOne(this,'age')"><div class="cicon">ğŸ’</div><div class="clabel">å°å­¦1å¹´ç”Ÿ</div><div class="cdesc">å›½èªãƒ»ç®—æ•°</div><div class="ck"></div></div>
        <div class="choice-card" data-val="sho2" onclick="selectOne(this,'age')"><div class="cicon">ğŸ“š</div><div class="clabel">å°å­¦2å¹´ç”Ÿ</div><div class="cdesc">æ¼¢å­—ãƒ»ãŸã—ç®—</div><div class="ck"></div></div>
        <div class="choice-card" data-val="sho3" onclick="selectOne(this,'age')"><div class="cicon">ğŸ“</div><div class="clabel">å°å­¦3å¹´ç”Ÿ</div><div class="cdesc">æ¼¢å­—ãƒ»ã‹ã‘ç®—</div><div class="ck"></div></div>
      </div>
      <div class="btn-row"><button class="btn btn-next" id="next0" onclick="goStep(1)" disabled>ã¤ãã¸ â†’</button></div>
    </div>

    <div class="step" id="step1">
      <div class="step-eyebrow">Step 2</div>
      <div class="step-title">ã©ã‚“ãªç·´ç¿’ã‚’<br>ã™ã‚‹ï¼Ÿ</div>
      <div class="step-sub">è¤‡æ•°é¸ã¹ã‚‹ã‚ˆï¼ˆ1ã¤ä»¥ä¸Šãˆã‚‰ã‚“ã§ã­ï¼‰</div>
      <div class="card-grid" id="subject-grid"></div>
      <div class="btn-row">
        <button class="btn btn-back" onclick="goStep(0)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next" id="next1" onclick="goStep(2)" disabled>ã¤ãã¸ â†’</button>
      </div>
    </div>

    <div class="step" id="step2">
      <div class="step-eyebrow">Step 3</div>
      <div class="step-title">ç¨®é¡ã‚’<br>é¸ã¼ã†ï¼</div>
      <div class="step-sub">è¤‡æ•°é¸ã¹ã‚‹ã‚ˆ</div>
      <div id="detail-grid" class="card-grid"></div>
      <div class="btn-row">
        <button class="btn btn-back" onclick="goStep(1)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next" id="next2" onclick="goStep(3)" disabled>ã¤ãã¸ â†’</button>
      </div>
    </div>

    <div class="step" id="step3">
      <div class="step-eyebrow">Step 4</div>
      <div class="step-title">ãƒšãƒ¼ã‚¸æ•°ã‚’<br>é¸ã¼ã†ï¼</div>
      <div class="step-sub">A4æ¨ªãƒ»1æšã«2ç¨®é¡å…¥ã‚‹ã‚ˆ</div>
      <div class="card-grid three">
        <div class="choice-card" data-val="1" onclick="selectOne(this,'pages')"><div class="cicon">ğŸ“„</div><div class="clabel">1æš</div><div class="ck"></div></div>
        <div class="choice-card" data-val="2" onclick="selectOne(this,'pages')"><div class="cicon">ğŸ“„</div><div class="clabel">2æš</div><div class="ck"></div></div>
        <div class="choice-card" data-val="3" onclick="selectOne(this,'pages')"><div class="cicon">ğŸ“š</div><div class="clabel">3æš</div><div class="ck"></div></div>
        <div class="choice-card" data-val="4" onclick="selectOne(this,'pages')"><div class="cicon">ğŸ“š</div><div class="clabel">4æš</div><div class="ck"></div></div>
        <div class="choice-card" data-val="5" onclick="selectOne(this,'pages')"><div class="cicon">ğŸ—‚ï¸</div><div class="clabel">5æš</div><div class="ck"></div></div>
      </div>
      <div class="summary-card">
        <h3>Selected</h3>
        <div class="srow"><span class="slabel">å¹´é½¢ãƒ»å­¦å¹´</span><span class="sval" id="sum-age">â€”</span></div>
        <div class="srow"><span class="slabel">æ•™ç§‘</span><span class="sval" id="sum-subject">â€”</span></div>
        <div class="srow"><span class="slabel">ç·´ç¿’å†…å®¹</span><span class="sval" id="sum-detail">â€”</span></div>
        <div class="srow"><span class="slabel">ãƒšãƒ¼ã‚¸æ•°</span><span class="sval" id="sum-pages">â€”</span></div>
      </div>
      <div class="notice">ğŸ’¡ ãƒ‰ãƒªãƒ«ã‚’ä½œã£ãŸã‚ã¨ã€Œã‹ã‚“ã‚Šã‚‡ã†ï¼ã€ã‚’æŠ¼ã™ã¨<br>ãƒ ãƒ‹ã¡ã‚ƒã‚“ãŒè‚²ã¤ã‚ˆ ğŸ¥š</div>
      <div class="btn-row" style="margin-top:16px;">
        <button class="btn btn-back" onclick="goStep(2)">â† ã‚‚ã©ã‚‹</button>
        <button class="btn btn-next btn-print" id="next3" onclick="generateAndPrint()" disabled>ğŸ–¨ï¸ ãƒ‰ãƒªãƒ«ã‚’ä½œã‚‹ï¼</button>
      </div>
      <button class="btn-reset" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>

      <div class="kanryo-card" id="kanryo-card" style="display:none;">
        <div class="kanryo-emoji" id="kanryo-emoji">ğŸ¥š</div>
        <div class="kanryo-title">ãƒ‰ãƒªãƒ«ã‚„ã‚ŠãŠã‚ã£ãŸã‚‰ï¼</div>
        <div class="kanryo-sub">ãƒ ãƒ‹ã¡ã‚ƒã‚“ã«å ±å‘Šã—ã¦XPã‚’ã‚²ãƒƒãƒˆã—ã‚ˆã†</div>
        <div class="dtype-wrap" id="kanryo-dtype-grid"></div>
        <button class="btn-kanryo" onclick="handleKanryo()">âœ… <span id="kanryo-dtype-label">ã†ã‚“ã´ã¤</span>ã‚’ã‹ã‚“ã‚Šã‚‡ã†ï¼</button>
      </div>
    </div>
  </div>

  <!-- IKUSEI TAB -->
  <div id="tab-ikusei" style="display:none;">
    <div style="height:14px"></div>
    <div class="creature-card">
      <div id="glow-bg" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;border-radius:var(--r);"></div>
      <div class="stage-row">
        <span class="stage-pill">STAGE <span id="i-stage-num">0</span> / 5</span>
        <span class="streak-pill">ğŸ”¥ <span id="i-streak">0</span> ã‚Œã‚“ãã</span>
      </div>
      <div class="creature-center">
        <div id="creature-svg-wrap" style="display:inline-block;"></div>
        <div id="levelup-pop" class="levelup-pop" style="display:none;"></div>
        <div id="particle-layer" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;"></div>
      </div>
      <!-- åå‰ -->
      <div style="text-align:center;margin-bottom:10px;position:relative;">
        <div style="display:flex;align-items:center;justify-content:center;gap:4px;">
          <span class="creature-name" id="creature-name-disp">ãƒ ãƒ‹ã¡ã‚ƒã‚“</span>
          <button class="name-edit-btn" onclick="toggleNameEdit()">âœï¸ ãªã¾ãˆ</button>
        </div>
        <div class="creature-name-sub" id="i-stage-desc">ã¾ã ä½•ã‹ãŒçœ ã£ã¦ã„ã‚‹â€¦</div>
        <div id="name-edit-wrap" style="display:none;">
          <div class="name-input-wrap">
            <input class="name-input" id="name-input" type="text" maxlength="8" placeholder="ãªã¾ãˆã‚’å…¥åŠ›â€¦">
          </div>
          <button class="name-save-btn" onclick="saveName()">æ±ºå®šï¼</button>
        </div>
      </div>
      <div class="xp-section">
        <div class="xp-meta">
          <span>EXP <span id="i-xp">0</span> / <span id="i-xp-next">3</span></span>
          <span id="i-xp-rem">NEXT: 3</span>
        </div>
        <div class="xp-bg"><div class="xp-fill" id="i-xp-bar" style="width:0%"></div></div>
      </div>
      <div class="stat-row">
        <div class="stat-box"><div class="sbi">ğŸ“„</div><div class="sbl">Drills</div><div class="sbv" id="i-total">0</div></div>
        <div class="stat-box"><div class="sbi">â­</div><div class="sbl">Exp</div><div class="sbv" id="i-xp2">0</div></div>
        <div class="stat-box"><div class="sbi">ğŸ…</div><div class="sbl">Badges</div><div class="sbv" id="i-badge-count">0</div></div>
      </div>
    </div>
    <div style="background:var(--card);border-radius:var(--r);padding:16px;border:2px solid var(--bd);box-shadow:var(--shadow-sm);">
      <div style="font-size:11px;font-weight:900;color:var(--txs);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">ãƒ‰ãƒªãƒ«ã®ã—ã‚…ã‚‹ã„</div>
      <div class="dtype-wrap" id="ikusei-dtype-grid"></div>
      <button onclick="handleKanryo()" style="width:100%;padding:15px;border-radius:99px;border:none;background:linear-gradient(135deg,var(--p),var(--i));color:white;font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 6px 20px rgba(195,104,249,.4);letter-spacing:-.01em;">
        âœ… <span id="ikusei-dtype-label">ã†ã‚“ã´ã¤</span>ã‚’ã‹ã‚“ã‚Šã‚‡ã†ï¼
      </button>
    </div>
  </div>

  <!-- REPORT TAB -->
  <div id="tab-report" style="display:none;">
    <div style="height:14px"></div>
    <div style="font-size:22px;font-weight:900;letter-spacing:-.02em;margin-bottom:16px;">ğŸ“Š å­¦ç¿’ãƒ¬ãƒãƒ¼ãƒˆ</div>

    <!-- ã‚µãƒãƒªãƒ¼ -->
    <div class="report-section" style="margin-bottom:12px;">
      <h3><span>ğŸ¯</span> ã‚µãƒãƒªãƒ¼</h3>
      <div class="report-grid" id="report-summary"></div>
    </div>

    <!-- é€±é–“ã‚°ãƒ©ãƒ• -->
    <div class="report-section">
      <h3><span>ğŸ“…</span> ä»Šé€±ã®ãã‚ã</h3>
      <div class="chart-wrap" id="week-chart"></div>
      <div style="display:flex;justify-content:space-between;margin-top:2px;" id="week-labels"></div>
    </div>

    <!-- æ•™ç§‘åˆ¥ -->
    <div class="report-section">
      <h3><span>ğŸ“š</span> ãã‚‡ã†ã‹ã¹ã¤</h3>
      <div class="subject-bar-wrap" id="subject-report"></div>
    </div>

    <!-- ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="report-section">
      <h3><span>ğŸ”¥</span> ã‚Œã‚“ããã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç›´è¿‘28æ—¥ï¼‰</h3>
      <div style="display:flex;justify-content:space-around;margin-bottom:6px;">
        <span style="font-size:10px;font-weight:700;color:var(--txs);">æœˆ</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">ç«</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">æ°´</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">æœ¨</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">é‡‘</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">åœŸ</span>
        <span style="font-size:10px;font-weight:700;color:var(--txs);">æ—¥</span>
      </div>
      <div class="streak-calendar" id="streak-cal"></div>
    </div>
  </div>

  <!-- LOG TAB -->
  <div id="tab-log" style="display:none;">
    <div style="height:14px"></div>
    <div style="font-size:22px;font-weight:900;letter-spacing:-.02em;margin-bottom:16px;">ğŸ“‹ ãã‚ã</div>
    <div id="log-list"><div style="text-align:center;color:var(--txs);padding:48px 0;font-size:13px;font-weight:700;">ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-weight:400;font-size:12px;margin-top:4px;display:block;">ãƒ‰ãƒªãƒ«ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</span></div></div>
  </div>

  <!-- BADGES TAB -->
  <div id="tab-badges" style="display:none;">
    <div style="height:14px"></div>
    <div style="font-size:22px;font-weight:900;letter-spacing:-.02em;margin-bottom:16px;">ğŸ… ãƒãƒƒã‚¸</div>
    <div class="badge-grid" id="badge-grid"></div>
  </div>
</main>

<div class="toast" id="toast" style="display:none;"></div>
<div id="print-target"></div>

<script>
// ===== DATA =====
const STAGES=[
  {id:0,name:"ã‚¿ãƒã‚´",xp:0,desc:"ã¾ã ä½•ã‹ãŒçœ ã£ã¦ã„ã‚‹â€¦",col:"rgba(195,104,249,.06)"},
  {id:1,name:"ãƒ¡ãƒ¡",xp:3,desc:"ç›®ãŒé–‹ã„ãŸï¼å¥½å¥‡å¿ƒæ—ºç››",col:"rgba(195,104,249,.1)"},
  {id:2,name:"ãƒ ãƒ‹",xp:8,desc:"ä½“ãŒç”Ÿãˆã¦ããŸã€‚ã§ã‚“ãã‚Šè¿”ã—ãŒå¥½ã",col:"rgba(135,106,255,.12)"},
  {id:3,name:"ãƒ ãƒ‹ãƒ ãƒ‹",xp:18,desc:"è§¦æ‰‹ãŒå¢—ãˆãŸï¼è¸Šã‚Šå‡ºã—ãŸ",col:"rgba(135,106,255,.16)"},
  {id:4,name:"ã‚°ãƒ«ã‚°ãƒ«",xp:32,desc:"ç©ºã‚’é£›ã¹ã‚‹ã‚ˆã†ã«ãªã£ãŸï¼",col:"rgba(195,104,249,.18)"},
  {id:5,name:"ãƒã‚¸ã‚«ãƒ«ãƒ ",xp:50,desc:"å®Œå…¨ä½“ï¼å®‡å®™ã¸æ—…ç«‹ã¤æº–å‚™å®Œäº†",col:"rgba(245,198,0,.1)"},
];
const BADGES=[
  {id:"first",icon:"âš¡",name:"ã¯ã˜ã‚ã®ä¸€æ­©",cond:s=>s.totalDrills>=1},
  {id:"three",icon:"ğŸ”¥",name:"3ã«ã¡ã‚Œã‚“ãã",cond:s=>s.streak>=3},
  {id:"ten",icon:"ğŸ’",name:"10ã¾ã„ãŸã£ã›ã„",cond:s=>s.totalDrills>=10},
  {id:"stage3",icon:"ğŸš€",name:"ã‚¹ãƒ†ãƒ¼ã‚¸3ã¨ã¤ã«ã‚…ã†",cond:s=>s.stage>=3},
  {id:"graduate",icon:"ğŸ‘‘",name:"ãã¤ãã‚‡ã†ï¼",cond:s=>s.stage>=5},
];

let ikusei={xp:0,stage:0,totalDrills:0,streak:0,log:[],badges:[],creatureName:"ãƒ ãƒ‹ã¡ã‚ƒã‚“",subjectCount:{},dailyDrills:{}};
let currentDrillType="ã†ã‚“ã´ã¤";
const DRILL_TYPES=["ã†ã‚“ã´ã¤","ã²ã‚‰ãŒãª","ã‹ãš","æ¼¢å­—","ãŸã—ç®—","ã²ãç®—","ä¹ä¹","æ™‚è¨ˆ"];

// ===== NAME EDIT =====
function toggleNameEdit(){
  const w=document.getElementById('name-edit-wrap');
  const inp=document.getElementById('name-input');
  const showing=w.style.display==='block';
  w.style.display=showing?'none':'block';
  if(!showing){inp.value=ikusei.creatureName;inp.focus();}
}
function saveName(){
  const v=document.getElementById('name-input').value.trim();
  if(v){ikusei.creatureName=v;document.getElementById('creature-name-disp').textContent=v;}
  document.getElementById('name-edit-wrap').style.display='none';
  showToast(`åå‰ã‚’ã€Œ${ikusei.creatureName}ã€ã«ã—ãŸã‚ˆï¼`);
}

// ===== SVG CREATURE =====
function creatureSVG(stage,anim){
  const s=stage;
  const st=`<style>
    @keyframes fc{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
    @keyframes cb{0%,100%{transform:translateY(0)}40%{transform:translateY(-20px)}70%{transform:translateY(-14px)}}
    @keyframes eb{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.08)}}
    @keyframes t1{0%,100%{transform:rotate(0)}50%{transform:rotate(13deg)}}
    @keyframes t2{0%,100%{transform:rotate(0)}50%{transform:rotate(-13deg)}}
    @keyframes sp{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
    .fc{animation:fc 2.8s ease-in-out infinite}
    .cb{animation:cb .6s ease}
    .ey{animation:eb 3s infinite;transform-origin:center}
    .ey2{animation:eb 3s .35s infinite;transform-origin:center}
    .ta{animation:t1 1.8s ease-in-out infinite}
    .tb{animation:t2 2.1s ease-in-out infinite}
    .tc{animation:t1 1.5s ease-in-out infinite}
    .s1{animation:sp 1.2s ease-in-out infinite}
    .s2{animation:sp 1.5s .4s ease-in-out infinite}
    .s3{animation:sp 1.8s .8s ease-in-out infinite}
  </style>`;
  let inner='';
  if(s===0) inner=`<ellipse cx="80" cy="95" rx="38" ry="46" fill="#ede0ff" stroke="#C368F9" stroke-width="2.5"/><ellipse cx="80" cy="95" rx="28" ry="36" fill="white" opacity=".4"/><text x="80" y="102" text-anchor="middle" font-size="22">ğŸ’¤</text>`;
  else if(s===1) inner=`<ellipse cx="80" cy="98" rx="36" ry="40" fill="#e0d0ff" stroke="#C368F9" stroke-width="2.5"/><g class="ey"><ellipse cx="68" cy="88" rx="9" ry="10" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="70" cy="87" r="5" fill="#876AFF"/><circle cx="71.5" cy="85.5" r="1.8" fill="white"/></g><g class="ey2"><ellipse cx="92" cy="88" rx="9" ry="10" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="94" cy="87" r="5" fill="#876AFF"/><circle cx="95.5" cy="85.5" r="1.8" fill="white"/></g><path d="M74,100 Q80,105 86,100" fill="none" stroke="#C368F9" stroke-width="2" stroke-linecap="round"/><ellipse cx="62" cy="96" rx="6" ry="4" fill="#f0a0d0" opacity=".5"/><ellipse cx="98" cy="96" rx="6" ry="4" fill="#f0a0d0" opacity=".5"/>`;
  else if(s===2) inner=`<ellipse cx="80" cy="95" rx="34" ry="38" fill="#d8c4ff" stroke="#C368F9" stroke-width="2.5"/><ellipse cx="80" cy="85" rx="26" ry="28" fill="#ede0ff"/><g class="ey"><ellipse cx="68" cy="80" rx="10" ry="11" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="70" cy="79" r="6" fill="#5533ee"/><circle cx="72" cy="77" r="2" fill="white"/></g><g class="ey2"><ellipse cx="93" cy="80" rx="10" ry="11" fill="white" stroke="#876AFF" stroke-width="1.5"/><circle cx="95" cy="79" r="6" fill="#5533ee"/><circle cx="97" cy="77" r="2" fill="white"/></g><path d="M72,94 Q80,101 88,94" fill="none" stroke="#C368F9" stroke-width="2.5" stroke-linecap="round"/><ellipse cx="59" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".55"/><ellipse cx="101" cy="88" rx="7" ry="5" fill="#f0a0d0" opacity=".55"/><ellipse cx="65" cy="128" rx="10" ry="6" fill="#c8b0ff"/><ellipse cx="95" cy="128" rx="10" ry="6" fill="#c8b0ff"/>`;
  else if(s===3) inner=`<g class="ta" style="transform-origin:65px 118px"><path d="M65,118 Q50,100 45,80 Q42,65 52,58" fill="none" stroke="#a888ff" stroke-width="5" stroke-linecap="round"/><circle cx="52" cy="56" r="6" fill="#C368F9"/></g><g class="tb" style="transform-origin:95px 118px"><path d="M95,118 Q110,100 115,80 Q118,65 108,58" fill="none" stroke="#a888ff" stroke-width="5" stroke-linecap="round"/><circle cx="108" cy="56" r="6" fill="#C368F9"/></g><g class="tc" style="transform-origin:80px 125px"><path d="M80,125 Q72,138 68,148" fill="none" stroke="#a888ff" stroke-width="4" stroke-linecap="round"/><circle cx="67" cy="150" r="5" fill="#876AFF"/><path d="M80,125 Q88,138 92,148" fill="none" stroke="#a888ff" stroke-width="4" stroke-linecap="round"/><circle cx="93" cy="150" r="5" fill="#876AFF"/></g><ellipse cx="80" cy="92" rx="32" ry="34" fill="#c8b0ff" stroke="#876AFF" stroke-width="2.5"/><ellipse cx="80" cy="84" rx="24" ry="25" fill="#ddd0ff"/><g class="ey"><ellipse cx="67" cy="79" rx="11" ry="12" fill="white" stroke="#6644cc" stroke-width="1.5"/><circle cx="69" cy="78" r="7" fill="#4422bb"/><circle cx="71" cy="76" r="2.5" fill="white"/></g><g class="ey2"><ellipse cx="93" cy="79" rx="11" ry="12" fill="white" stroke="#6644cc" stroke-width="1.5"/><circle cx="95" cy="78" r="7" fill="#4422bb"/><circle cx="97" cy="76" r="2.5" fill="white"/></g><path d="M70,96 Q80,104 90,96" fill="none" stroke="#7744cc" stroke-width="2.5" stroke-linecap="round"/>`;
  else if(s===4) inner=`<ellipse cx="80" cy="90" rx="62" ry="14" fill="none" stroke="#C368F9" stroke-width="3" opacity=".4"/>${[[55,105,32,60],[105,105,128,60],[62,120,46,155],[98,120,114,155]].map(([x1,y1,x3,y3],i)=>`<g class="${['ta','tb','tc','ta'][i]}" style="transform-origin:${x1}px ${y1}px"><path d="M${x1},${y1} Q${(x1+x3)/2},${(y1+y3)/2} ${x3},${y3}" fill="none" stroke="#8855ee" stroke-width="4.5" stroke-linecap="round"/><circle cx="${x3}" cy="${y3}" r="6" fill="#C368F9"/></g>`).join('')}<ellipse cx="80" cy="88" rx="30" ry="32" fill="#b898ff" stroke="#7744ee" stroke-width="2.5"/><ellipse cx="80" cy="80" rx="22" ry="23" fill="#ccc0ff"/><g class="ey"><ellipse cx="67" cy="75" rx="11" ry="13" fill="white" stroke="#5533cc" stroke-width="1.5"/><circle cx="69" cy="74" r="7.5" fill="#3311aa"/><circle cx="71" cy="72" r="2.5" fill="white"/></g><g class="ey2"><ellipse cx="93" cy="75" rx="11" ry="13" fill="white" stroke="#5533cc" stroke-width="1.5"/><circle cx="95" cy="74" r="7.5" fill="#3311aa"/><circle cx="97" cy="72" r="2.5" fill="white"/></g><path d="M70,92 Q80,101 90,92" fill="#9966ff" stroke="#5533cc" stroke-width="1.5" stroke-linecap="round"/><g class="s1"><text x="22" y="55" font-size="14">âœ¨</text></g><g class="s2"><text x="120" y="50" font-size="12">â­</text></g><g class="s3"><text x="130" y="100" font-size="10">ğŸ’«</text></g>`;
  else inner=`${[0,30,60,90,120,150,180,210,240,270,300,330].map(a=>`<line x1="${80+28*Math.cos(a*Math.PI/180)}" y1="${70+28*Math.sin(a*Math.PI/180)}" x2="${80+42*Math.cos(a*Math.PI/180)}" y2="${70+42*Math.sin(a*Math.PI/180)}" stroke="#f5c800" stroke-width="2" opacity=".7"/>`).join('')}<circle cx="80" cy="70" r="24" fill="#ffe060" opacity=".3"/>${[[55,108,26,62,'ta','#C368F9'],[105,108,134,62,'tb','#C368F9'],[58,118,38,158,'tc','#60E2B7'],[102,118,122,158,'ta','#C368F9'],[68,122,55,160,'tb','#f5c800'],[92,122,105,160,'tc','#876AFF']].map(([x1,y1,x3,y3,cls,sc])=>`<g class="${cls}" style="transform-origin:${x1}px ${y1}px"><path d="M${x1},${y1} Q${(x1+x3)/2},${(y1+y3)/2} ${x3},${y3}" fill="none" stroke="${sc}" stroke-width="5" stroke-linecap="round"/><circle cx="${x3}" cy="${y3}" r="7" fill="${sc}"/></g>`).join('')}<ellipse cx="80" cy="88" rx="30" ry="32" fill="url(#rg5)" stroke="#6633ff" stroke-width="3"/><defs><radialGradient id="rg5" cx="40%" cy="35%"><stop offset="0%" stop-color="#f0e0ff"/><stop offset="100%" stop-color="#9966ff"/></radialGradient></defs><path d="M62,66 L66,56 L72,63 L80,52 L88,63 L94,56 L98,66 Z" fill="#f5c800" stroke="#e0a000" stroke-width="1.5"/><g class="ey"><ellipse cx="67" cy="77" rx="11" ry="13" fill="white" stroke="#4400cc" stroke-width="2"/><text x="67" y="82" text-anchor="middle" font-size="14">â­</text></g><g class="ey2"><ellipse cx="93" cy="77" rx="11" ry="13" fill="white" stroke="#4400cc" stroke-width="2"/><text x="93" y="82" text-anchor="middle" font-size="14">â­</text></g><path d="M70,95 Q80,104 90,95" fill="#cc88ff" stroke="#6600cc" stroke-width="2" stroke-linecap="round"/>${[["âœ¨",15,38,"s1"],["â­",135,32,"s2"],["ğŸ’«",18,120,"s3"],["ğŸŒŸ",132,115,"s1"]].map(([e,x,y,c])=>`<g class="${c}"><text x="${x}" y="${y}" font-size="13">${e}</text></g>`).join('')}`;
  return `<svg viewBox="0 0 160 160" width="160" height="160" style="overflow:visible">${st}<g class="${anim?'cb':'fc'}">${inner}</g></svg>`;
}

function renderCreature(anim=false){const w=document.getElementById('creature-svg-wrap');if(w)w.innerHTML=creatureSVG(ikusei.stage,anim);}

function updateIkuseiUI(){
  const s=STAGES[ikusei.stage],nxt=STAGES[Math.min(ikusei.stage+1,STAGES.length-1)];
  const maxed=ikusei.stage>=STAGES.length-1;
  const prog=maxed?100:Math.min(100,((ikusei.xp-s.xp)/(nxt.xp-s.xp))*100);
  document.getElementById('i-stage-num').textContent=ikusei.stage;
  document.getElementById('i-streak').textContent=ikusei.streak;
  document.getElementById('i-stage-desc').textContent=s.desc;
  document.getElementById('i-xp').textContent=ikusei.xp;
  document.getElementById('i-xp2').textContent=ikusei.xp;
  document.getElementById('i-xp-next').textContent=maxed?'MAX':nxt.xp;
  document.getElementById('i-xp-rem').textContent=maxed?'MAX!':'NEXT: '+(nxt.xp-ikusei.xp);
  document.getElementById('i-xp-bar').style.width=prog+'%';
  document.getElementById('i-total').textContent=ikusei.totalDrills;
  document.getElementById('i-badge-count').textContent=ikusei.badges.length;
  document.getElementById('glow-bg').style.background=`radial-gradient(ellipse at 50% 30%,${s.col},transparent 70%)`;
  document.getElementById('creature-name-disp').textContent=ikusei.creatureName;
  const ke=document.getElementById('kanryo-emoji');if(ke)ke.textContent=['ğŸ¥š','ğŸ‘€','ğŸŸ£','ğŸ¦‘','ğŸŒ€','ğŸ‘‘'][ikusei.stage]||'ğŸ¥š';
}

function renderDrillTypes(){
  ['kanryo-dtype-grid','ikusei-dtype-grid'].forEach(id=>{
    const g=document.getElementById(id);if(!g)return;g.innerHTML='';
    DRILL_TYPES.forEach(t=>{
      const b=document.createElement('button');b.className='dtype-btn'+(t===currentDrillType?' sel':'');b.textContent=t;
      b.onclick=()=>{currentDrillType=t;renderDrillTypes();['kanryo-dtype-label','ikusei-dtype-label'].forEach(i=>{const el=document.getElementById(i);if(el)el.textContent=t;});};
      g.appendChild(b);
    });
  });
}

function handleKanryo(){
  const gain=Math.floor(Math.random()*2)+1;
  const prevStage=ikusei.stage;
  ikusei.xp+=gain;ikusei.totalDrills++;ikusei.streak++;
  ikusei.subjectCount[currentDrillType]=(ikusei.subjectCount[currentDrillType]||0)+1;
  const today=new Date().toISOString().slice(0,10);
  ikusei.dailyDrills[today]=(ikusei.dailyDrills[today]||0)+1;
  const newStage=[...STAGES].reverse().find(s=>ikusei.xp>=s.xp)?.id??0;
  if(newStage>prevStage){ikusei.stage=newStage;renderCreature(true);showLevelUp(STAGES[newStage]);}
  else{renderCreature(true);setTimeout(()=>renderCreature(false),700);}
  const now=new Date();
  ikusei.log.unshift({date:`${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`,type:currentDrillType,xp:gain,stageName:STAGES[ikusei.stage].name});
  if(ikusei.log.length>30)ikusei.log.pop();
  checkBadges();updateIkuseiUI();renderLog();renderBadges();spawnParticles();
  showToast(`+${gain}XP ã‚²ãƒƒãƒˆï¼`);
  setTimeout(()=>switchTab('ikusei'),800);
}

function checkBadges(){BADGES.forEach(b=>{if(!ikusei.badges.includes(b.id)&&b.cond({totalDrills:ikusei.totalDrills,streak:ikusei.streak,stage:ikusei.stage})){ikusei.badges.push(b.id);setTimeout(()=>showToast(`${b.icon} ãƒãƒƒã‚¸ã‚²ãƒƒãƒˆï¼ã€Œ${b.name}ã€`),1200);}});}

function showLevelUp(si){
  const el=document.getElementById('levelup-pop');el.style.display='block';
  el.innerHTML=`<div style="font-size:22px;">ğŸ‰</div><div style="font-size:14px;font-weight:900;color:var(--p);margin-top:4px;">STAGE UP!</div><div style="font-size:16px;font-weight:900;color:var(--i);margin-top:2px;">ã€Œ${si.name}ã€ã«ãªã£ãŸï¼</div>`;
  setTimeout(()=>{el.style.display='none';renderCreature(false);},2600);
}

function spawnParticles(){
  const layer=document.getElementById('particle-layer');layer.innerHTML='';
  ['â­','âœ¨','ğŸ’«','ğŸŒŸ','ğŸ’œ'].forEach((e,i)=>{
    const span=document.createElement('span');span.textContent=e;
    span.style.cssText=`position:absolute;font-size:18px;left:${20+Math.random()*120}px;top:${40+Math.random()*80}px;animation:particleFly .9s ease-out ${i*0.08}s forwards;pointer-events:none;`;
    layer.appendChild(span);
  });
  setTimeout(()=>layer.innerHTML='',1000);
}

let toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  t.style.animation='none';t.offsetHeight;t.style.animation='toastIn .4s cubic-bezier(.4,2,.6,1)';
  if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.style.display='none',2200);
}

function renderLog(){
  const el=document.getElementById('log-list');
  if(!ikusei.log.length){el.innerHTML='<div style="text-align:center;color:var(--txs);padding:48px 0;font-size:13px;font-weight:700;">ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-weight:400;font-size:12px;">ãƒ‰ãƒªãƒ«ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</span></div>';return;}
  el.innerHTML=ikusei.log.map(l=>`<div class="log-item"><div class="log-icon">ğŸ“„</div><div style="flex:1"><div style="font-size:13px;font-weight:900;">${l.type}</div><div style="font-size:11px;color:var(--txs);margin-top:1px;">${l.date} Â· ${l.stageName}</div></div><span class="xp-chip">+${l.xp}XP</span></div>`).join('');
}

function renderBadges(){
  document.getElementById('badge-grid').innerHTML=BADGES.map(b=>{const e=ikusei.badges.includes(b.id);return `<div class="badge-item ${e?'earned':'locked'}"><div class="bicon" style="filter:${e?'none':'grayscale(1)'}">${b.icon}</div><div class="bname" style="color:${e?'var(--i)':'#888'}">${b.name}</div><div class="bstatus" style="color:${e?'var(--p)':'#aaa'}">${e?'âœ“ ã‚²ãƒƒãƒˆï¼':'???'}</div></div>`;}).join('');
}

// ===== REPORT =====
function renderReport(){
  // ã‚µãƒãƒªãƒ¼
  const totalXp=ikusei.xp;
  const bestSubject=Object.entries(ikusei.subjectCount).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('report-summary').innerHTML=`
    <div class="report-item"><div class="ri-val">${ikusei.totalDrills}<span class="ri-unit">ã¾ã„</span></div><div class="ri-label">Total Drills</div></div>
    <div class="report-item"><div class="ri-val">${totalXp}<span class="ri-unit">XP</span></div><div class="ri-label">Total EXP</div></div>
    <div class="report-item"><div class="ri-val">${ikusei.streak}<span class="ri-unit">æ—¥</span></div><div class="ri-label">Streak</div></div>
    <div class="report-item"><div class="ri-val">${bestSubject?bestSubject[0]:'â€”'}</div><div class="ri-label">Best Subject</div></div>`;

  // é€±é–“ã‚°ãƒ©ãƒ•ï¼ˆç›´è¿‘7æ—¥ï¼‰
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const weekData=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const key=d.toISOString().slice(0,10);
    weekData.push({label:days[d.getDay()],val:ikusei.dailyDrills[key]||0});
  }
  const maxVal=Math.max(...weekData.map(d=>d.val),1);
  document.getElementById('week-chart').innerHTML=weekData.map(d=>`<div class="chart-bar-wrap"><div class="chart-bar" style="height:${Math.max((d.val/maxVal)*68,d.val>0?8:4)}px;opacity:${d.val>0?1:.3};"></div></div>`).join('');
  document.getElementById('week-labels').innerHTML=weekData.map(d=>`<span style="font-size:10px;font-weight:700;color:var(--txs);flex:1;text-align:center;">${d.label}</span>`).join('');

  // æ•™ç§‘åˆ¥
  const totalCount=Object.values(ikusei.subjectCount).reduce((a,b)=>a+b,0)||1;
  const subjects=DRILL_TYPES.filter(t=>ikusei.subjectCount[t]);
  document.getElementById('subject-report').innerHTML=subjects.length?subjects.sort((a,b)=>(ikusei.subjectCount[b]||0)-(ikusei.subjectCount[a]||0)).map(t=>`
    <div class="subject-bar-row">
      <span class="subject-bar-label">${t}</span>
      <div class="subject-bar-bg"><div class="subject-bar-fill" style="width:${(ikusei.subjectCount[t]||0)/totalCount*100}%"></div></div>
      <span class="subject-bar-val">${ikusei.subjectCount[t]||0}</span>
    </div>`).join(''):'<div style="color:var(--txs);font-size:13px;text-align:center;padding:16px;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';

  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  const calCells=[];
  for(let i=27;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const key=d.toISOString().slice(0,10);
    const done=ikusei.dailyDrills[key]>0;
    const isToday=i===0;
    calCells.push(`<div class="scal-cell ${done?'done':''} ${isToday?'today':''}" title="${key}"></div>`);
  }
  document.getElementById('streak-cal').innerHTML=calCells.join('');
}

function switchTab(tab){
  ['drill','ikusei','report','log','badges'].forEach(t=>{
    const el=document.getElementById('tab-'+t);if(el)el.style.display=t===tab?'block':'none';
    const nav=document.getElementById('nav-'+t);if(nav)nav.classList.toggle('act',t===tab);
  });
  if(tab==='ikusei')renderCreature(false);
  if(tab==='report')renderReport();
  if(tab==='log')renderLog();
  if(tab==='badges')renderBadges();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ===== DRILL STATE =====
const dstate={age:'',subject:[],detail:[],pages:''};
const stepLabels=['STEP 1 / 4','STEP 2 / 4','STEP 3 / 4','STEP 4 / 4'];
const progWidths=['25%','50%','75%','100%'];
const ageLabel={yoji2:'2ã€œ3æ­³',yoji4:'4ã€œ5æ­³',yoji6:'å¹´é•·ï¼ˆ5ã€œ6æ­³ï¼‰',sho1:'å°å­¦1å¹´ç”Ÿ',sho2:'å°å­¦2å¹´ç”Ÿ',sho3:'å°å­¦3å¹´ç”Ÿ'};
const sbjLabel={unpitsu:'ã†ã‚“ã´ã¤',hiragana:'ã²ã‚‰ãŒãª',kotoba:'ã“ã¨ã°',kazu:'ã‹ãš',kanji1:'æ¼¢å­—(1å¹´)',kanji2:'æ¼¢å­—(2å¹´)',kanji3:'æ¼¢å­—(3å¹´)',tasizan:'ãŸã—ç®—',hikizan:'ã²ãç®—',tokei:'æ™‚è¨ˆ',tasizan2:'ãŸã—ç®—',hikizan2:'ã²ãç®—',kuku:'ä¹ä¹',tokei2:'æ™‚è¨ˆ',kakezan:'ã‹ã‘ç®—',warizan:'ã‚ã‚Šç®—',masu:'ãƒã‚¹è¨ˆç®—'};
const subjectsByAge={
  yoji2:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šã®ç·´ç¿’'},{val:'kazu',icon:'ğŸ”¢',label:'ã‹ãš',desc:'ã‹ããˆã‚‹ãƒ»ãƒ‰ãƒƒãƒˆ'}],
  yoji4:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šã®ç·´ç¿’'},{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'ã‚ˆã¿ãƒ»ã“ã¨ã°'},{val:'kazu',icon:'ğŸ”¢',label:'ã‹ãš',desc:'ã‹ãšã®æ¦‚å¿µãƒ»åˆæˆ'}],
  yoji6:[{val:'unpitsu',icon:'âœï¸',label:'ã†ã‚“ã´ã¤',desc:'ç·šã®ç·´ç¿’'},{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'ã‚ˆã¿ãƒ»æ›¸ã'},{val:'kotoba',icon:'ğŸ’¬',label:'ã“ã¨ã°',desc:'èªå½™'},{val:'kazu',icon:'ğŸ”¢',label:'ã‹ãš',desc:'åˆæˆãƒ»åˆ†è§£ãƒ»é †åº'}],
  sho1:[{val:'hiragana',icon:'ğŸ”¤',label:'ã²ã‚‰ãŒãª',desc:'èª­ã¿æ›¸ã'},{val:'kanji1',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ1å¹´ï¼‰',desc:'80å­—'},{val:'tasizan',icon:'â•',label:'ãŸã—ç®—',desc:'1æ¡'},{val:'hikizan',icon:'â–',label:'ã²ãç®—',desc:'1æ¡'},{val:'tokei',icon:'ğŸ•',label:'æ™‚è¨ˆ',desc:'ä½•æ™‚ãƒ»åŠ'}],
  sho2:[{val:'kanji2',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ2å¹´ï¼‰',desc:'160å­—'},{val:'tasizan2',icon:'â•',label:'ãŸã—ç®—',desc:'2æ¡'},{val:'hikizan2',icon:'â–',label:'ã²ãç®—',desc:'2æ¡'},{val:'kuku',icon:'âœ–ï¸',label:'ä¹ä¹',desc:'2ã€œ9æ®µ'},{val:'tokei2',icon:'ğŸ•',label:'æ™‚è¨ˆ',desc:'ä½•æ™‚ä½•åˆ†'}],
  sho3:[{val:'kanji3',icon:'æ¼¢',label:'æ¼¢å­—ï¼ˆ3å¹´ï¼‰',desc:'200å­—'},{val:'kakezan',icon:'âœ–ï¸',label:'ã‹ã‘ç®—',desc:'2ãƒ»3æ¡'},{val:'warizan',icon:'â—',label:'ã‚ã‚Šç®—',desc:'ã‚ã¾ã‚Šãªã—'},{val:'masu',icon:'ğŸ”²',label:'ãƒã‚¹è¨ˆç®—',desc:'ãŸã—ãƒ»ã²ã'}],
};
const kazuDetailsByAge={
  yoji2:[{val:'kazu_dot',icon:'ğŸ”µ',label:'ãƒ‰ãƒƒãƒˆèªè­˜',desc:'ã„ãã¤ã‚ã‚‹ï¼Ÿ'},{val:'kazu_count3',icon:'âœ‹',label:'1ã€œ3ã‹ããˆã‚‹'},{val:'kazu_count5',icon:'ğŸ–ï¸',label:'1ã€œ5ã‹ããˆã‚‹'}],
  yoji4:[{val:'kazu_count5',icon:'ğŸ–ï¸',label:'1ã€œ5ã‹ããˆã‚‹'},{val:'kazu_count10',icon:'ğŸ”Ÿ',label:'1ã€œ10ã‹ããˆã‚‹'},{val:'kazu_ikutsu',icon:'ğŸ§©',label:'ã„ãã¤ã¨ã„ãã¤'},{val:'kazu_daisho',icon:'âš–ï¸',label:'ãŠãŠãã„ãƒ»ã¡ã„ã•ã„'}],
  yoji6:[{val:'kazu_count10',icon:'ğŸ”Ÿ',label:'1ã€œ10ã‹ããˆã‚‹'},{val:'kazu_ikutsu',icon:'ğŸ§©',label:'ã„ãã¤ã¨ã„ãã¤'},{val:'kazu_awasete',icon:'â•',label:'ã‚ã‚ã›ã¦ã„ãã¤'},{val:'kazu_junjo',icon:'ğŸ“Š',label:'ãªã‚“ã°ã‚“ã‚'},{val:'kazu_daisho',icon:'âš–ï¸',label:'ãŠãŠãã„ãƒ»ã¡ã„ã•ã„'}],
};
const detailsBySubject={
  unpitsu:[{val:'yoko',icon:'â¡ï¸',label:'æ¨ªç·š'},{val:'tate',icon:'â¬‡ï¸',label:'ç¸¦ç·š'},{val:'nami',icon:'ğŸŒŠ',label:'æ³¢ç·š'},{val:'zag',icon:'âš¡',label:'ã‚¸ã‚°ã‚¶ã‚°'}],
  hiragana:[{val:'dobutsu',icon:'ğŸ¶',label:'ã©ã†ã¶ã¤'},{val:'tabemono',icon:'ğŸ',label:'ãŸã¹ã‚‚ã®'},{val:'norimono',icon:'ğŸšŒ',label:'ã®ã‚Šã‚‚ã®'},{val:'shizen',icon:'ğŸŒ¸',label:'ã—ãœã‚“'}],
  kotoba:[{val:'dobutsu',icon:'ğŸ¶',label:'ã©ã†ã¶ã¤'},{val:'tabemono',icon:'ğŸ',label:'ãŸã¹ã‚‚ã®'}],
  kazu:[],
  kanji1:[{val:'kanji1a',icon:'å±±',label:'è‡ªç„¶ãƒ»ä½“'},{val:'kanji1b',icon:'ä¸€',label:'æ•°ãƒ»é‡'},{val:'kanji1c',icon:'æ—¥',label:'æ—¥ãƒ»æœˆãƒ»å¹´'}],
  kanji2:[{val:'kanji2a',icon:'æ˜¥',label:'å­£ç¯€'},{val:'kanji2b',icon:'æ±',label:'æ–¹è§’'},{val:'kanji2c',icon:'è¦ª',label:'å®¶æ—'}],
  kanji3:[{val:'kanji3a',icon:'æ—',label:'ç”Ÿæ´»'},{val:'kanji3b',icon:'è¾²',label:'è‡ªç„¶ãƒ»ç”£æ¥­'}],
  tasizan:[{val:'tasu1',icon:'â•',label:'ãã‚Šä¸ŠãŒã‚Šãªã—'},{val:'tasu2',icon:'â•',label:'ãã‚Šä¸ŠãŒã‚Š'}],
  hikizan:[{val:'hiki1',icon:'â–',label:'ãã‚Šä¸‹ãŒã‚Šãªã—'},{val:'hiki2',icon:'â–',label:'ãã‚Šä¸‹ãŒã‚Š'}],
  tokei:[{val:'tokei_h',icon:'ğŸ•',label:'ä½•æ™‚'},{val:'tokei_hh',icon:'ğŸ•§',label:'ä½•æ™‚åŠ'}],
  tasizan2:[{val:'tasu2a',icon:'â•',label:'2æ¡+1æ¡'},{val:'tasu2b',icon:'â•',label:'2æ¡+2æ¡'}],
  hikizan2:[{val:'hiki2a',icon:'â–',label:'2æ¡-1æ¡'},{val:'hiki2b',icon:'â–',label:'2æ¡-2æ¡'}],
  kuku:[{val:'kuku2',icon:'âœ–ï¸',label:'2ã€œ4æ®µ'},{val:'kuku5',icon:'âœ–ï¸',label:'5ã€œ7æ®µ'},{val:'kuku8',icon:'âœ–ï¸',label:'8ã€œ9æ®µ'}],
  tokei2:[{val:'tokei_min',icon:'ğŸ•',label:'ä½•æ™‚ä½•åˆ†'},{val:'tokei_all',icon:'ğŸ•',label:'çµŒéæ™‚é–“'}],
  kakezan:[{val:'kake2',icon:'âœ–ï¸',label:'2æ¡Ã—1æ¡'},{val:'kake3',icon:'âœ–ï¸',label:'3æ¡Ã—1æ¡'}],
  warizan:[{val:'wari1',icon:'â—',label:'Ã·1æ¡'}],
  masu:[{val:'masu_tasu',icon:'ï¼‹',label:'ãŸã—ç®—ãƒã‚¹'},{val:'masu_hiki',icon:'ï¼',label:'ã²ãç®—ãƒã‚¹'}],
};
const detailNames={yoko:'æ¨ªç·š',tate:'ç¸¦ç·š',nami:'æ³¢ç·š',zag:'ã‚¸ã‚°ã‚¶ã‚°',dobutsu:'ã©ã†ã¶ã¤',tabemono:'ãŸã¹ã‚‚ã®',norimono:'ã®ã‚Šã‚‚ã®',shizen:'ã—ãœã‚“',kazu_dot:'ãƒ‰ãƒƒãƒˆèªè­˜',kazu_count3:'1ã€œ3ã‹ããˆã‚‹',kazu_count5:'1ã€œ5ã‹ããˆã‚‹',kazu_count10:'1ã€œ10ã‹ããˆã‚‹',kazu_ikutsu:'ã„ãã¤ã¨ã„ãã¤',kazu_awasete:'ã‚ã‚ã›ã¦ã„ãã¤',kazu_junjo:'ãªã‚“ã°ã‚“ã‚',kazu_daisho:'ãŠãŠãã„ãƒ»ã¡ã„ã•ã„',kanji1a:'è‡ªç„¶ãƒ»ä½“',kanji1b:'æ•°ãƒ»é‡',kanji1c:'æ—¥ãƒ»æœˆãƒ»å¹´',kanji2a:'å­£ç¯€',kanji2b:'æ–¹è§’',kanji2c:'å®¶æ—',kanji3a:'ç”Ÿæ´»',kanji3b:'è‡ªç„¶',tasu1:'1æ¡ãŸã—ç®—',tasu2:'ãã‚Šä¸ŠãŒã‚Š',hiki1:'1æ¡ã²ãç®—',hiki2:'ãã‚Šä¸‹ãŒã‚Š',tokei_h:'ä½•æ™‚',tokei_hh:'ä½•æ™‚åŠ',tasu2a:'2æ¡+1æ¡',tasu2b:'2æ¡+2æ¡',hiki2a:'2æ¡-1æ¡',hiki2b:'2æ¡-2æ¡',kuku2:'2ã€œ4æ®µ',kuku5:'5ã€œ7æ®µ',kuku8:'8ã€œ9æ®µ',tokei_min:'ä½•æ™‚ä½•åˆ†',tokei_all:'çµŒéæ™‚é–“',kake2:'2æ¡Ã—1æ¡',kake3:'3æ¡Ã—1æ¡',wari1:'Ã·1æ¡',masu_tasu:'ãŸã—ç®—ãƒã‚¹',masu_hiki:'ã²ãç®—ãƒã‚¹'};

function selectOne(el,key){
  el.closest('[class*="card-grid"]').querySelectorAll('.choice-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');dstate[key]=el.dataset.val;
  if(key==='age')buildSubjectGrid();if(key==='pages')updateSummary();updateNextBtn();
}
function selectMulti(el,key){
  el.classList.toggle('selected');
  dstate[key]=[...el.closest('[class*="card-grid"]').querySelectorAll('.choice-card.selected')].map(c=>c.dataset.val);
  if(key==='subject')buildDetailGrid();updateNextBtn();updateSummary();
}
function updateNextBtn(){
  document.getElementById('next0').disabled=!dstate.age;
  document.getElementById('next1').disabled=dstate.subject.length===0;
  document.getElementById('next2').disabled=dstate.detail.length===0;
  document.getElementById('next3').disabled=!dstate.pages;
}
function goStep(n){
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.sdot').forEach((d,i)=>{d.classList.toggle('done',i<n);d.classList.toggle('active',i===n);});
  document.getElementById('prog-label').textContent=stepLabels[n];
  document.getElementById('prog-fill').style.width=progWidths[n];
  if(n===3)updateSummary();
  window.scrollTo({top:0,behavior:'smooth'});
}
function buildSubjectGrid(){
  const g=document.getElementById('subject-grid');g.innerHTML='';dstate.subject=[];
  (subjectsByAge[dstate.age]||[]).forEach(opt=>{
    const d=document.createElement('div');d.className='choice-card';d.dataset.val=opt.val;
    d.innerHTML=`<div class="ck"></div><div class="cicon">${opt.icon}</div><div class="clabel">${opt.label}</div><div class="cdesc">${opt.desc||''}</div>`;
    d.onclick=()=>selectMulti(d,'subject');g.appendChild(d);
  });updateNextBtn();
}
function buildDetailGrid(){
  const g=document.getElementById('detail-grid');g.innerHTML='';dstate.detail=[];
  dstate.subject.forEach(sub=>{
    const opts=sub==='kazu'?(kazuDetailsByAge[dstate.age]||[]):detailsBySubject[sub];
    if(!opts||!opts.length)return;
    const h=document.createElement('div');h.className='sec-label';h.textContent=(sbjLabel[sub]||sub).toUpperCase();g.appendChild(h);
    opts.forEach(opt=>{
      const d=document.createElement('div');d.className='choice-card';d.dataset.val=opt.val;
      d.innerHTML=`<div class="ck"></div><div class="cicon">${opt.icon}</div><div class="clabel">${opt.label}</div><div class="cdesc">${opt.desc||''}</div>`;
      d.onclick=()=>{d.classList.toggle('selected');dstate.detail=[...g.querySelectorAll('.choice-card.selected')].map(c=>c.dataset.val);updateNextBtn();updateSummary();};
      g.appendChild(d);
    });
  });updateNextBtn();
}
function updateSummary(){
  document.getElementById('sum-age').textContent=ageLabel[dstate.age]||'â€”';
  document.getElementById('sum-subject').textContent=dstate.subject.map(s=>sbjLabel[s]||s).join('ãƒ»')||'â€”';
  document.getElementById('sum-detail').textContent=dstate.detail.map(d=>detailNames[d]||d).join('ãƒ»')||'â€”';
  document.getElementById('sum-pages').textContent=dstate.pages?dstate.pages+'æš':'â€”';
  const dtype=dstate.subject.length>0?(sbjLabel[dstate.subject[0]]||'ã†ã‚“ã´ã¤'):'ã†ã‚“ã´ã¤';
  currentDrillType=dtype;
  ['kanryo-dtype-label','ikusei-dtype-label'].forEach(i=>{const el=document.getElementById(i);if(el)el.textContent=dtype;});
  renderDrillTypes();
}
function resetAll(){
  dstate.age='';dstate.subject=[];dstate.detail=[];dstate.pages='';
  document.querySelectorAll('.choice-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('kanryo-card').style.display='none';
  goStep(0);updateNextBtn();
}

// ===== DRILL PRINT CONTENT (same as main version) =====
const OM_BASE='https://cdn.jsdelivr.net/gh/hfg-gmuend/openmoji/color/svg/';
const OM={dog:'1F436',cat:'1F431',bear:'1F43B',rabbit:'1F430',elephant:'1F418',monkey:'1F412',tiger:'1F42F',fox:'1F98A',apple:'1F34E',banana:'1F34C',strawberry:'1F353',grapes:'1F347',peach:'1F351',orange:'1F34A',watermelon:'1F349',melon:'1F348',bus:'1F68C',train:'1F683',car:'1F697',airplane:'2708',ship:'1F6A2',bicycle:'1F6B2',shinkansen:'1F685',taxi:'1F695',cherry_blossom:'1F338',cloud:'2601',mountain:'26F0',ocean:'1F30A',mushroom:'1F344',star:'2B50',moon:'1F319',wind:'1F32C',fish:'1F41F',dolphin:'1F42C',octopus:'1F419',tropical_fish:'1F420',frog:'1F438',rooster:'1F413',chick:'1F425',truck:'1F69B',lightning:'26A1'};
function omImg(hex,cls='om'){return `<img src="${OM_BASE}${hex.toUpperCase()}.svg" class="${cls}" loading="lazy" onerror="this.style.visibility='hidden'">`;}
const kokugoThemes={
  dobutsu:[{word:'ã„ã¬',hex:OM.dog,bg:'#ede0ff'},{word:'ã­ã“',hex:OM.cat,bg:'#e0edff'},{word:'ãã¾',hex:OM.bear,bg:'#e0ffe8'},{word:'ã†ã•ã',hex:OM.rabbit,bg:'#fff0e0'},{word:'ãã†',hex:OM.elephant,bg:'#e8e0ff'},{word:'ã•ã‚‹',hex:OM.monkey,bg:'#e0f4ff'},{word:'ã¨ã‚‰',hex:OM.tiger,bg:'#fff8e0'},{word:'ãã¤ã­',hex:OM.fox,bg:'#ffe8e0'}],
  tabemono:[{word:'ã‚Šã‚“ã”',hex:OM.apple,bg:'#ffe0e8'},{word:'ãƒãƒŠãƒŠ',hex:OM.banana,bg:'#fffde0'},{word:'ã„ã¡ã”',hex:OM.strawberry,bg:'#e0ffe8'},{word:'ã¶ã©ã†',hex:OM.grapes,bg:'#ede0ff'},{word:'ã‚‚ã‚‚',hex:OM.peach,bg:'#ffe8e0'},{word:'ã¿ã‹ã‚“',hex:OM.orange,bg:'#fff4e0'},{word:'ã™ã„ã‹',hex:OM.watermelon,bg:'#e0fff4'},{word:'ãƒ¡ãƒ­ãƒ³',hex:OM.melon,bg:'#e8ffe0'}],
  norimono:[{word:'ãƒã‚¹',hex:OM.bus,bg:'#e0f0ff'},{word:'ã§ã‚“ã—ã‚ƒ',hex:OM.train,bg:'#e0e8ff'},{word:'ãã‚‹ã¾',hex:OM.car,bg:'#fff4e0'},{word:'ã²ã“ã†ã',hex:OM.airplane,bg:'#e8f8ff'},{word:'ãµã­',hex:OM.ship,bg:'#e0f8ff'},{word:'ã˜ã¦ã‚“ã—ã‚ƒ',hex:OM.bicycle,bg:'#e8ffe0'},{word:'ã—ã‚“ã‹ã‚“ã›ã‚“',hex:OM.shinkansen,bg:'#ede0ff'},{word:'ã‚¿ã‚¯ã‚·ãƒ¼',hex:OM.taxi,bg:'#fffde0'}],
  shizen:[{word:'ã¯ãª',hex:OM.cherry_blossom,bg:'#ffe0ed'},{word:'ãã‚‰',hex:OM.cloud,bg:'#e0f4ff'},{word:'ã‚„ã¾',hex:OM.mountain,bg:'#e8ffe0'},{word:'ã†ã¿',hex:OM.ocean,bg:'#e0f8ff'},{word:'ãã®ã“',hex:OM.mushroom,bg:'#ffe8e0'},{word:'ã»ã—',hex:OM.star,bg:'#fffde0'},{word:'ã¤ã',hex:OM.moon,bg:'#ede0ff'},{word:'ã‹ãœ',hex:OM.wind,bg:'#e0faff'}],
};
const kanjiData={
  kanji1a:[{char:'å±±',read:'ã‚„ã¾',ex:'å±±ãƒ»å±±é“'},{char:'å·',read:'ã‹ã‚',ex:'å·ãƒ»å·è¾º'},{char:'æœ¨',read:'ã',ex:'æœ¨ãƒ»æœ¨ã®è‘‰'},{char:'ç«',read:'ã²',ex:'ç«ãƒ»ç«å±±'},{char:'æ°´',read:'ã¿ãš',ex:'æ°´ãƒ»æ°´é“'},{char:'åœŸ',read:'ã¤ã¡',ex:'åœŸãƒ»åœŸåœ°'},{char:'ç©º',read:'ãã‚‰',ex:'ç©ºãƒ»é’ç©º'},{char:'èŠ±',read:'ã¯ãª',ex:'èŠ±ãƒ»èŠ±ç•‘'}],
  kanji1b:[{char:'ä¸€',read:'ã„ã¡',ex:'ä¸€ã¤ãƒ»ä¸€ç•ª'},{char:'äºŒ',read:'ã«',ex:'äºŒã¤ãƒ»äºŒå›'},{char:'ä¸‰',read:'ã•ã‚“',ex:'ä¸‰ã¤ãƒ»ä¸‰è§’'},{char:'å››',read:'ã—',ex:'å››ã¤ãƒ»å››æ–¹'},{char:'äº”',read:'ã”',ex:'äº”ã¤ãƒ»äº”æœˆ'},{char:'å…­',read:'ã‚ã',ex:'å…­ã¤ãƒ»å…­æœˆ'},{char:'ä¸ƒ',read:'ãªãª',ex:'ä¸ƒã¤ãƒ»ä¸ƒå¤•'},{char:'å…«',read:'ã¯ã¡',ex:'å…«ã¤ãƒ»å…«æœˆ'}],
  kanji1c:[{char:'æ—¥',read:'ã«ã¡',ex:'ä»Šæ—¥ãƒ»æ—¥æœ¬'},{char:'æœˆ',read:'ã¤ã',ex:'æœˆãƒ»æœˆæ›œ'},{char:'å¹´',read:'ã­ã‚“',ex:'ä»Šå¹´ãƒ»ä¸€å¹´'},{char:'æ™‚',read:'ã¨ã',ex:'æ™‚é–“ãƒ»ä¸€æ™‚'},{char:'åˆ†',read:'ãµã‚“',ex:'ååˆ†ãƒ»ä¸€åˆ†'},{char:'ä¸Š',read:'ã†ãˆ',ex:'ä¸Šãƒ»ä¸Šæ‰‹'},{char:'ä¸‹',read:'ã—ãŸ',ex:'ä¸‹ãƒ»ä¸‹æ‰‹'},{char:'ä¸­',read:'ãªã‹',ex:'ä¸­ãƒ»ä¸­å¿ƒ'}],
  kanji2a:[{char:'æ˜¥',read:'ã¯ã‚‹',ex:'æ˜¥é¢¨ãƒ»æ˜¥ä¼‘ã¿'},{char:'å¤',read:'ãªã¤',ex:'å¤ç©ºãƒ»å¤ä¼‘ã¿'},{char:'ç§‹',read:'ã‚ã',ex:'ç§‹ç©ºãƒ»ç§‹é¢¨'},{char:'å†¬',read:'ãµã‚†',ex:'å†¬ç©ºãƒ»å†¬ä¼‘ã¿'},{char:'é›¨',read:'ã‚ã‚',ex:'é›¨ãƒ»å¤§é›¨'},{char:'é›ª',read:'ã‚†ã',ex:'é›ªãƒ»é›ªå±±'},{char:'é¢¨',read:'ã‹ãœ',ex:'é¢¨ãƒ»åŒ—é¢¨'},{char:'æ™´',read:'ã¯ã‚Œ',ex:'æ™´ã‚Œãƒ»å¿«æ™´'}],
  kanji2b:[{char:'æ±',read:'ã²ãŒã—',ex:'æ±ãƒ»æ±é¢¨'},{char:'è¥¿',read:'ã«ã—',ex:'è¥¿ãƒ»è¥¿æ—¥'},{char:'å—',read:'ã¿ãªã¿',ex:'å—ãƒ»å—é¢¨'},{char:'åŒ—',read:'ããŸ',ex:'åŒ—ãƒ»åŒ—é¢¨'},{char:'å³',read:'ã¿ã',ex:'å³ãƒ»å³æ‰‹'},{char:'å·¦',read:'ã²ã ã‚Š',ex:'å·¦ãƒ»å·¦æ‰‹'},{char:'å‰',read:'ã¾ãˆ',ex:'å‰ãƒ»å‰å¾Œ'},{char:'å¾Œ',read:'ã†ã—ã‚',ex:'å¾Œãƒ»å¾Œæ—¥'}],
  kanji2c:[{char:'è¦ª',read:'ãŠã‚„',ex:'ä¸¡è¦ªãƒ»è¦ªå­'},{char:'å‹',read:'ã¨ã‚‚',ex:'å‹äººãƒ»å‹é”'},{char:'å…„',read:'ã‚ã«',ex:'å…„ãƒ»å…„å¼Ÿ'},{char:'å¼Ÿ',read:'ãŠã¨ã†ã¨',ex:'å¼Ÿãƒ»å…„å¼Ÿ'},{char:'å§‰',read:'ã‚ã­',ex:'å§‰ãƒ»å§‰å¦¹'},{char:'å¦¹',read:'ã„ã‚‚ã†ã¨',ex:'å¦¹ãƒ»å§‰å¦¹'}],
  kanji3a:[{char:'æ—',read:'ãã',ex:'å®¶æ—ãƒ»ä¸€æ—'},{char:'åŒ»',read:'ã„',ex:'åŒ»è€…ãƒ»åŒ»é™¢'},{char:'æ—…',read:'ãŸã³',ex:'æ—…è¡Œãƒ»æ—…äºº'},{char:'éƒ¨',read:'ã¶',ex:'éƒ¨æ´»ãƒ»éƒ¨åˆ†'},{char:'å‘³',read:'ã‚ã˜',ex:'å‘³ãƒ»å‘³æ–¹'}],
  kanji3b:[{char:'è¾²',read:'ã®ã†',ex:'è¾²æ¥­ãƒ»è¾²å®¶'},{char:'æ¥­',read:'ãã‚‡ã†',ex:'ç”£æ¥­ãƒ»å·¥æ¥­'},{char:'æ¤',read:'ã†ãˆã‚‹',ex:'æ¤ç‰©ãƒ»æ¤ãˆã‚‹'},{char:'æ—',read:'ã¯ã‚„ã—',ex:'æ—ãƒ»å±±æ—'},{char:'æ£®',read:'ã‚‚ã‚Š',ex:'æ£®ãƒ»æ£®æ—'}],
};
const KAZU_ITEMS=['ğŸ','ğŸ¶','â­','ğŸŒ¸','ğŸˆ','ğŸ­','ğŸ±','ğŸ©'];
function getQC(){if(dstate.age==='sho3')return 15;if(dstate.age==='sho2')return 12;if(dstate.age==='sho1')return 10;return 4;}
function getKFS(n){if(n>=15)return'12pt';if(n>=12)return'13pt';if(n>=10)return'14pt';return'16pt';}
function getKCols(n){return n>=12?3:2;}
let kokugoCtrs={};
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function dColH(t){return `<div class="d-hdr"><span class="d-title">${t}</span><span class="d-brand">ãƒ‰ãƒªã‚¸ã‚§ãƒ</span></div><div class="d-meta"><span class="d-circle"></span><span>ãŒã¤</span><span class="d-circle"></span><span>ã«ã¡</span><span style="margin-left:3px;">ãªã¾ãˆ</span><div class="d-name"></div></div>`;}
function dGrid(){let h='<div class="d-grids">';for(let i=0;i<2;i++)h+=`<div class="d-grid-block"><div class="d-gnum">1</div><div class="d-gcells"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div><div class="d-gnum" style="margin-top:1mm;">2</div><div class="d-gcells"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`;return h+'</div>';}
function makeUnpitsu(type){
  const titles={yoko:'ã¾ã£ã™ã ã†ã‚“ã´ã¤ï¼ˆã‚ˆã“ï¼‰',tate:'ã¾ã£ã™ã ã†ã‚“ã´ã¤ï¼ˆãŸã¦ï¼‰',nami:'ãªã¿ãªã¿ ã†ã‚“ã´ã¤',zag:'ã–ã–ã– ã†ã‚“ã´ã¤'};
  const instrs={yoko:'ã²ã ã‚Šã‹ã‚‰ ã¿ãã¸ ã›ã‚“ã‚’ ã²ãã¾ã—ã‚‡ã†ã€‚',tate:'ã†ãˆã‹ã‚‰ ã—ãŸã¸ ã›ã‚“ã‚’ ã²ãã¾ã—ã‚‡ã†ã€‚',nami:'ãªã¿ãªã¿ã¨ ã›ã‚“ã‚’ ã‹ãã¾ã—ã‚‡ã†ã€‚',zag:'ã–ã–ã–ã¨ ã›ã‚“ã‚’ ã‹ãã¾ã—ã‚‡ã†ã€‚'};
  const rows={yoko:[[OM.ship,OM.ship],[OM.truck,OM.truck],[OM.bus,OM.bus]],tate:[[OM.frog,OM.frog],[OM.fish,OM.fish],[OM.rooster,OM.rooster],[OM.chick,OM.chick]],nami:[[OM.tropical_fish,OM.tropical_fish],[OM.dolphin,OM.dolphin],[OM.octopus,OM.octopus]],zag:[[OM.mountain,OM.mountain],[OM.lightning,OM.lightning],[OM.star,OM.star]]};
  let h=dColH(titles[type])+`<div class="d-instr"><span style="color:#C368F9;">â—</span>${instrs[type]}</div>`;
  if(type==='yoko'){h+='<div class="d-zz-frame">';rows.yoko.forEach(([l,r])=>h+=`<div class="d-zz-row">${omImg(l,'om')}<div class="d-zz-guide"></div>${omImg(r,'om')}</div>`);h+='</div>';}
  else if(type==='tate'){h+='<div class="d-vert-frame">';rows.tate.forEach(([t,b])=>h+=`<div class="d-vert-col">${omImg(t,'om-sm')}<div class="d-vert-guide"></div>${omImg(b,'om-sm')}</div>`);h+='</div>';}
  else if(type==='nami'){h+='<div class="d-wave-frame">';rows.nami.forEach(([l,r])=>h+=`<div class="d-wave-row">${omImg(l,'om')}<svg class="d-wave-svg" viewBox="0 0 300 50" preserveAspectRatio="none"><path d="M0,25 Q37,5 75,25 Q112,45 150,25 Q187,5 225,25 Q262,45 300,25" fill="none" stroke="#a098e8" stroke-width="3" stroke-dasharray="10,6"/></svg>${omImg(r,'om')}</div>`);h+='</div>';}
  else{h+='<div class="d-zg-frame">';rows.zag.forEach(([l,r])=>h+=`<div class="d-zg-row">${omImg(l,'om')}<svg style="position:absolute;left:58px;right:58px;top:0;bottom:0;width:calc(100% - 116px);height:100%;" viewBox="0 0 300 50" preserveAspectRatio="none"><polyline points="0,38 60,10 120,38 180,10 240,38 300,10" fill="none" stroke="#a098e8" stroke-width="3" stroke-dasharray="10,6" stroke-linejoin="round"/></svg>${omImg(r,'om')}</div>`);h+='</div>';}
  return h;
}
function makeHiragana(theme){
  if(!kokugoCtrs[theme])kokugoCtrs[theme]=0;
  const words=kokugoThemes[theme]||kokugoThemes.dobutsu;
  const w=[0,1,2,3].map(i=>words[(kokugoCtrs[theme]+i)%words.length]);
  kokugoCtrs[theme]+=4;
  let h=dColH('ã²ã‚‰ãŒãª ã“ã¨ã°ã‚«ãƒ¼ãƒ‰')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã“ã¨ã°ã‚’ ã‚ˆã¿ã¾ã—ã‚‡ã†ã€‚</div><div class="d-cards-col">`;
  h+=`<div class="d-card-pair"><div class="d-kana-card" style="background:${w[0].bg};"><div class="d-bubble">${w[0].word}</div>${omImg(w[0].hex,'d-card-om')}</div><div class="d-kana-card" style="background:${w[1].bg};"><div class="d-bubble">${w[1].word}</div>${omImg(w[1].hex,'d-card-om')}</div></div>`;
  h+=`<div class="d-card-pair"><div class="d-kana-card" style="background:${w[2].bg};"><div class="d-bubble">${w[2].word}</div>${omImg(w[2].hex,'d-card-om')}</div><div class="d-kana-card" style="background:${w[3].bg};"><div class="d-bubble">${w[3].word}</div>${omImg(w[3].hex,'d-card-om')}</div></div>`;
  return h+'</div>'+dGrid();
}
function makeKazu(type){
  const item=KAZU_ITEMS[ri(0,KAZU_ITEMS.length-1)];
  if(type==='kazu_dot'||type==='kazu_count3'){
    let h=dColH('ã‹ãšã‚’ ã‹ããˆã‚ˆã†ï¼')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã„ãã¤ã‚ã‚‹ã‹ ã‹ããˆã¦ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-kazu-frame">`;
    for(let n=1;n<=3;n++)h+=`<div class="d-kazu-row"><div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;min-width:90px;">${Array(n).fill(`<span style="font-size:20pt;">${item}</span>`).join('')}</div><div style="font-size:10pt;color:#aaa;margin:0 4px;">â†’ ã„ãã¤ï¼Ÿ</div><div class="d-kazu-write" style="margin-left:auto;"><div class="d-cell d-slash"></div><div class="d-cell"></div></div></div>`;
    return h+'</div>';
  }
  if(type==='kazu_count5'||type==='kazu_count10'){
    const max=type==='kazu_count5'?5:10;
    const nums=[];while(nums.length<4){const n=ri(1,max);if(!nums.includes(n))nums.push(n);}
    let h=dColH(`ã‹ãšã‚’ ã‹ããˆã‚ˆã†ï¼ï¼ˆ1ã€œ${max}ï¼‰`)+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã„ãã¤ã‚ã‚‹ã‹ ã‹ããˆã¦ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-kazu-frame">`;
    nums.forEach(n=>h+=`<div class="d-kazu-row"><div style="display:flex;gap:3px;flex-wrap:wrap;align-items:center;max-width:140px;">${Array(n).fill(`<span style="font-size:${n>7?'15':'18'}pt;">${item}</span>`).join('')}</div><div class="d-kazu-write" style="margin-left:auto;"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);
    return h+'</div>';
  }
  if(type==='kazu_ikutsu'){
    let h=dColH('ã„ãã¤ã¨ ã„ãã¤ï¼Ÿ')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‚ã‚ã›ã‚‹ã¨ ã„ãã¤ã«ãªã‚‹ã‹ ã‹ã‚“ãŒãˆã¾ã—ã‚‡ã†ã€‚</div><div class="d-ikutsu-frame">`;
    [5,6,7,8].forEach(total=>{const a=ri(1,total-1);h+=`<div class="d-ikutsu-row"><span style="font-size:14pt;font-weight:900;">${total}</span><span style="font-size:12pt;color:#888;">ã¯</span><span class="d-ikutsu-box"></span><span style="font-size:12pt;color:#888;">ã¨</span><span style="font-size:14pt;font-weight:900;color:#C368F9;">${a}</span></div>`;});
    return h+'</div>';
  }
  if(type==='kazu_awasete'){
    let h=dColH('ã‚ã‚ã›ã¦ ã„ãã¤ï¼Ÿ')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‚ã‚ã›ã‚‹ã¨ ã„ãã¤ã« ãªã‚‹ã‹ãªï¼Ÿ</div><div class="d-ikutsu-frame">`;
    for(let i=0;i<4;i++){const a=ri(1,5),b=ri(1,5);h+=`<div class="d-ikutsu-row" style="font-size:13pt;"><span>${Array(a).fill(`<span style="font-size:14pt;">${item}</span>`).join('')}</span><span style="color:#888;font-size:11pt;">ã¨</span><span>${Array(b).fill(`<span style="font-size:14pt;">ğŸ”µ</span>`).join('')}</span><span style="color:#888;">â†’</span><span class="d-ikutsu-box"></span></div>`;}
    return h+'</div>';
  }
  if(type==='kazu_junjo'){
    const animals=['ğŸ¶','ğŸ±','ğŸ¸','ğŸ°','ğŸ»','ğŸ¥','ğŸŸ','ğŸ¦'];
    let h=dColH('ãªã‚“ã°ã‚“ã‚ï¼Ÿ')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã¾ãˆã‹ã‚‰ ãªã‚“ã°ã‚“ã‚ã‹ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-junjo-frame">`;
    for(let i=0;i<3;i++){const count=ri(4,6),target=ri(1,count);h+=`<div class="d-junjo-row"><div style="font-size:8pt;color:#888;min-width:20px;">ã¾ãˆâ†’</div>${Array.from({length:count},(_,j)=>`<div class="d-junjo-item ${j===target-1?'q':''}" style="font-size:13px;">${animals[(i*count+j)%animals.length]}</div>`).join('')}<div style="margin-left:6px;font-size:9pt;color:#555;">ã¯</div><div class="d-cell d-slash" style="width:12mm;height:12mm;margin-left:4px;"></div><div style="font-size:9pt;color:#555;">ã°ã‚“ã‚</div></div>`;}
    return h+'</div>';
  }
  if(type==='kazu_daisho'){
    let h=dColH('ãŠãŠãã„ ã‹ãšãƒ»ã¡ã„ã•ã„ ã‹ãš')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã©ã¡ã‚‰ãŒ ãŠãŠãã„ã‹ ï¼ ã‹ ï¼œ ã‚’ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-daisho-frame">`;
    for(let i=0;i<4;i++){const a=ri(1,10),b=ri(1,10);h+=`<div class="d-daisho-row"><span>${a}</span><div class="d-daisho-box"><span style="font-size:8pt;color:#aaa;">ï¼ã‹ï¼œ</span></div><span>${b}</span></div>`;}
    return h+'</div>';
  }
  return dColH('ã‹ãšã® ã‚Œã‚“ã—ã‚…ã†');
}
function makeKanji(type){
  const data=kanjiData[type]||kanjiData.kanji1a;
  const cnt=getQC(),show=Math.min(data.length,cnt>=10?8:6);
  let h=dColH('æ¼¢å­— ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‹ã‚“ã˜ã‚’ ã‚ˆã‚“ã§ã€ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-kanji-frame">`;
  data.slice(0,show).forEach(k=>h+=`<div class="d-kanji-row"><div class="d-kanji-char">${k.char}</div><div class="d-kanji-info"><b>ã‚ˆã¿ï¼š</b>${k.read}ã€€<b>ã‚Œã„ï¼š</b>${k.ex}</div><div class="d-kanji-write"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);
  return h+'</div>';
}
function makeKeisan(type){
  const cnt=getQC(),cols=getKCols(cnt),fs=getKFS(cnt);
  const titles={tasu1:'ãŸã—ç®—',tasu2:'ãŸã—ç®—ï¼ˆãã‚Šä¸ŠãŒã‚Šï¼‰',hiki1:'ã²ãç®—',hiki2:'ã²ãç®—ï¼ˆãã‚Šä¸‹ãŒã‚Šï¼‰',tasu2a:'ãŸã—ç®—ï¼ˆ2æ¡ï¼‰',tasu2b:'ãŸã—ç®—ï¼ˆ2æ¡ï¼‰',hiki2a:'ã²ãç®—ï¼ˆ2æ¡ï¼‰',hiki2b:'ã²ãç®—ï¼ˆ2æ¡ï¼‰',kake2:'ã‹ã‘ç®—',kake3:'ã‹ã‘ç®—ï¼ˆ3æ¡ï¼‰',wari1:'ã‚ã‚Šç®—'};
  let h=dColH((titles[type]||'ã‘ã„ã•ã‚“')+' ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã‘ã„ã•ã‚“ã—ã¾ã—ã‚‡ã†ã€‚</div><div class="d-keisan-frame"><div class="d-keisan-grid" style="grid-template-columns:repeat(${cols},1fr);">`;
  for(let i=0;i<cnt;i++){
    let a,b,op='ï¼‹';
    if(type==='tasu1'){a=ri(1,8);b=ri(1,9-a);}else if(type==='tasu2'){a=ri(2,9);b=ri(Math.max(1,10-a),9);}else if(type==='hiki1'){a=ri(2,9);b=ri(1,a-1);op='ï¼';}else if(type==='hiki2'){a=ri(11,18);b=ri(a-9,a-2);op='ï¼';}else if(type==='tasu2a'){a=ri(11,89);b=ri(1,9);}else if(type==='tasu2b'){a=ri(11,79);b=ri(11,Math.min(89,99-a));}else if(type==='hiki2a'){a=ri(11,99);b=ri(1,Math.min(9,a-1));op='ï¼';}else if(type==='hiki2b'){a=ri(20,99);b=ri(11,a-9);op='ï¼';}else if(type==='kake2'){a=ri(11,99);b=ri(2,9);op='Ã—';}else if(type==='kake3'){a=ri(100,999);b=ri(2,9);op='Ã—';}else if(type==='wari1'){b=ri(2,9);a=b*ri(2,9);op='Ã·';}else{a=ri(1,9);b=ri(1,9);}
    h+=`<div class="d-keisan-item" style="font-size:${fs};"><span class="d-qnum">${i+1}</span><span>${a}</span><span style="color:#876AFF;">${op}</span><span>${b}</span><span style="color:#876AFF;">ï¼</span><span class="d-ans-box"></span></div>`;
  }
  return h+'</div></div>';
}
function makeKuku(type){
  const cnt=getQC(),cols=getKCols(cnt),fs=getKFS(cnt);
  const ranges={kuku2:[2,3,4],kuku5:[5,6,7],kuku8:[8,9]};
  const danList=ranges[type]||[2,3,4];
  let h=dColH('ä¹ä¹ ã‚Œã‚“ã—ã‚…ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ããã‚’ ã‚Œã‚“ã—ã‚…ã†ã—ã¾ã—ã‚‡ã†ã€‚</div><div class="d-keisan-frame"><div class="d-keisan-grid" style="grid-template-columns:repeat(${cols},1fr);">`;
  for(let i=0;i<cnt;i++){const d=danList[i%danList.length],n=ri(1,9);h+=`<div class="d-keisan-item" style="font-size:${fs};"><span class="d-qnum">${i+1}</span><span>${d}</span><span style="color:#876AFF;">Ã—</span><span>${n}</span><span style="color:#876AFF;">ï¼</span><span class="d-ans-box"></span></div>`;}
  return h+'</div></div>';
}
function makeTokei(type){
  const sets={tokei_h:[{h:1,m:0},{h:3,m:0},{h:6,m:0},{h:9,m:0},{h:12,m:0},{h:10,m:0}],tokei_hh:[{h:1,m:30},{h:4,m:30},{h:7,m:30},{h:10,m:30},{h:2,m:30},{h:8,m:30}],tokei_min:[{h:2,m:15},{h:5,m:45},{h:8,m:20},{h:11,m:50},{h:3,m:35},{h:6,m:10}],tokei_all:[{h:9,m:0},{h:9,m:30},{h:10,m:0},{h:10,m:30},{h:8,m:15},{h:11,m:45}]};
  const times=sets[type]||sets.tokei_h;
  function svgC(hh,mm){const ha=((hh%12)+mm/60)/12*360-90,ma=mm/60*360-90,hx=26+14*Math.cos(ha*Math.PI/180),hy=26+14*Math.sin(ha*Math.PI/180),mx=26+20*Math.cos(ma*Math.PI/180),my=26+20*Math.sin(ma*Math.PI/180);let t='';for(let i=0;i<12;i++){const a=i/12*360-90;t+=`<line x1="${26+22*Math.cos(a*Math.PI/180)}" y1="${26+22*Math.sin(a*Math.PI/180)}" x2="${26+(i%3===0?17:20)*Math.cos(a*Math.PI/180)}" y2="${26+(i%3===0?17:20)*Math.sin(a*Math.PI/180)}" stroke="#555" stroke-width="${i%3===0?2:1}"/>`;}return `<svg class="d-clock-svg" viewBox="0 0 52 52"><circle cx="26" cy="26" r="24" fill="white" stroke="#aaa" stroke-width="1.5"/>${t}<line x1="26" y1="26" x2="${hx}" y2="${hy}" stroke="#333" stroke-width="2.5" stroke-linecap="round"/><line x1="26" y1="26" x2="${mx}" y2="${my}" stroke="#555" stroke-width="1.5" stroke-linecap="round"/><circle cx="26" cy="26" r="2" fill="#333"/></svg>`;}
  let h=dColH('ã¨ã‘ã„ã‚’ ã‚ˆã‚‚ã†')+`<div class="d-instr"><span style="color:#C368F9;">â—</span>ã¨ã‘ã„ã‚’ã‚ˆã‚“ã§ ã‹ãã¾ã—ã‚‡ã†ã€‚</div><div class="d-tokei-frame">`;
  times.forEach(t=>h+=`<div class="d-clock-cell">${svgC(t.h,t.m)}<div class="d-clock-write"><div class="d-cell d-slash"></div><div class="d-cell"></div><div class="d-cell"></div></div></div>`);
  return h+'</div>';
}
function makeColContent(detail){
  const up=['yoko','tate','nami','zag'],hi=['dobutsu','tabemono','norimono','shizen'],kj=['kanji1a','kanji1b','kanji1c','kanji2a','kanji2b','kanji2c','kanji3a','kanji3b'],kz=['kazu_dot','kazu_count3','kazu_count5','kazu_count10','kazu_ikutsu','kazu_awasete','kazu_junjo','kazu_daisho'],ks=['tasu1','tasu2','hiki1','hiki2','tasu2a','tasu2b','hiki2a','hiki2b','kake2','kake3','wari1','masu_tasu','masu_hiki'],kk=['kuku2','kuku5','kuku8'],tk=['tokei_h','tokei_hh','tokei_min','tokei_all'];
  if(up.includes(detail))return makeUnpitsu(detail);
  if(hi.includes(detail))return makeHiragana(detail);
  if(kj.includes(detail))return makeKanji(detail);
  if(kz.includes(detail))return makeKazu(detail);
  if(kk.includes(detail))return makeKuku(detail);
  if(tk.includes(detail))return makeTokei(detail);
  if(ks.includes(detail))return makeKeisan(detail);
  return dColH('â€”');
}
function generateAndPrint(){
  const pages=parseInt(dstate.pages);kokugoCtrs={};
  const slots=[...dstate.detail];
  while(slots.length<pages*2)slots.push(...slots.slice(0,Math.min(slots.length,pages*2-slots.length)));
  let html='';
  for(let i=0;i<pages;i++){const l=slots[(i*2)%slots.length],r=slots[(i*2+1)%slots.length];html+=`<div class="drill-page"><div class="drill-pid">p.${i+1}</div><div class="drill-two-col"><div class="drill-col">${makeColContent(l)}</div><div class="drill-divider"></div><div class="drill-col">${makeColContent(r)}</div></div></div>`;}
  const pt=document.getElementById('print-target');
  pt.innerHTML=html;
  pt.style.cssText='display:block;position:fixed;top:0;left:0;z-index:9999;background:#ede8ff;overflow-y:auto;width:100%;height:100%;';
  const close=document.createElement('button');
  close.textContent='âœ• ã¨ã˜ã‚‹';close.style.cssText='position:fixed;top:12px;right:12px;z-index:10000;background:linear-gradient(135deg,#C368F9,#876AFF);color:white;border:none;padding:10px 18px;border-radius:99px;font-size:14px;font-weight:900;cursor:pointer;box-shadow:0 4px 12px rgba(135,106,255,.3);font-family:inherit;';
  close.onclick=()=>{pt.style.display='none';pt.innerHTML='';};pt.prepend(close);
  const printBtn=document.createElement('button');
  printBtn.textContent='ğŸ–¨ï¸ å°åˆ·ã™ã‚‹';printBtn.style.cssText='position:fixed;top:12px;right:120px;z-index:10000;background:linear-gradient(135deg,#38b896,#60E2B7);color:white;border:none;padding:10px 18px;border-radius:99px;font-size:14px;font-weight:900;cursor:pointer;box-shadow:0 4px 12px rgba(96,226,183,.3);font-family:inherit;';
  printBtn.onclick=()=>window.print();pt.prepend(printBtn);
  document.getElementById('kanryo-card').style.display='block';
  renderDrillTypes();window.scrollTo({top:9999,behavior:'smooth'});
}

// INIT
renderCreature(false);updateIkuseiUI();renderDrillTypes();renderBadges();
</script>
</body>
</html>
